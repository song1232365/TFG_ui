<!DOCTYPE html>
<html lang="zh">  
<head>  
    <meta charset="UTF-8">  
    <meta name="viewport" content="width=device-width, initial-scale=1.0">  
    <title>æ¨¡å‹è®­ç»ƒç•Œé¢</title>  
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">  
    <style>  
        :root {  
            --primary-color: #00c6ff;  
            --secondary-color: #0072ff;  
            --accent-color: #00e5ff;  
            --bg-dark: #0a0a0a;  
            --bg-light: #1b1b1b;  
            --text-primary: #ffffff;  
            --text-secondary: rgba(255, 255, 255, 0.7);  
            --glass-bg: rgba(255, 255, 255, 0.05);  
            --glass-border: rgba(255, 255, 255, 0.2);  
            --neon-glow: rgba(0, 229, 255, 0.8);  
        }  
        /* æµ…è‰²ä¸»é¢˜å˜é‡ - ä½¿ç”¨æ–°çš„ç´«è‰²ç³»é…è‰² */  
        body.light-theme {  
            --primary-color: #6366f1;  
            --secondary-color: #8b5cf6;  
            --accent-color: #06b6d4;  
            --bg-dark: #f8fafc;  
            --bg-light: #ffffff;  
            --text-primary: #1e293b;  
            --text-secondary: rgba(30, 41, 59, 0.7);  
            --glass-bg: rgba(255, 255, 255, 0.9);  
            --glass-border: rgba(99, 102, 241, 0.2);  
        }  
        
        /* æµ…è‰²æ¨¡å¼èƒŒæ™¯ */  
        body.light-theme.subpage-bg {  
            background: radial-gradient(circle at top left, #e0e7ff 0%, #ffffff 50%, #f3f4f6 100%);  
        }  
        
        /* æµ…è‰²æ¨¡å¼ç²’å­å±‚ */  
        body.light-theme.subpage-bg::before {  
            opacity: 0.6;  
            filter: hue-rotate(20deg);  
            mix-blend-mode: multiply;  
        }  
        
        /* æµ…è‰²æ¨¡å¼3Dç½‘æ ¼çº¿ */  
        body.light-theme.subpage-bg::after {  
            opacity: 0.4;  
            background:   
                linear-gradient(45deg, transparent 40%, rgba(99, 102, 241, 0.05) 50%, transparent 60%),  
                linear-gradient(-45deg, transparent 40%, rgba(6, 182, 212, 0.05) 50%, transparent 60%);  
        }  
        
        /* æµ…è‰²æ¨¡å¼å®¹å™¨ */  
        body.light-theme .video-page-container {  
            background: rgba(255, 255, 255, 0.65);  
            border: 1px solid rgba(255, 255, 255, 0.8);  
            box-shadow: 0 20px 50px rgba(99, 102, 241, 0.1);  
            backdrop-filter: blur(20px) saturate(180%);  
        }  
        
        /* æµ…è‰²æ¨¡å¼è¿”å›æŒ‰é’® */  
        body.light-theme .back-btn {  
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);  
            border: 1px solid rgba(255, 255, 255, 0.4);  
            color: white;  
            box-shadow: 0 10px 20px rgba(99, 102, 241, 0.3);  
        }  
        
        body.light-theme .back-btn:hover {  
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);  
            box-shadow: 0 15px 30px rgba(124, 58, 237, 0.4);  
        }  
        
        /* æµ…è‰²æ¨¡å¼æ ‡é¢˜ */  
        body.light-theme h2 {  
            background: linear-gradient(135deg, #4f46e5, #06b6d4);  
            -webkit-background-clip: text;  
            background-clip: text;  
            -webkit-text-fill-color: transparent;  
            text-shadow: none;  
            filter: drop-shadow(0 2px 10px rgba(99, 102, 241, 0.2));  
        }  
        
        /* æµ…è‰²æ¨¡å¼è¡¨å•å…ƒç´  */  
        body.light-theme select,  
        body.light-theme input,  
        body.light-theme textarea {  
            background: rgba(255, 255, 255, 0.8);  
            border-color: rgba(99, 102, 241, 0.2);  
            color: var(--text-primary);  
        }  
        
        /* æµ…è‰²æ¨¡å¼ç”ŸæˆæŒ‰é’® */  
        body.light-theme .generate-btn {  
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);  
            border: 1px solid rgba(255, 255, 255, 0.4);  
            box-shadow: 0 10px 20px rgba(99, 102, 241, 0.3);  
        }  
        
        body.light-theme .generate-btn:hover {  
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);  
            box-shadow: 0 15px 30px rgba(124, 58, 237, 0.4);  
        }
  
        body.subpage-bg {  
            background: radial-gradient(circle at center, var(--bg-dark) 0%, var(--bg-light) 100%);  
            color: var(--text-primary);  
            font-family: "Segoe UI", "Microsoft YaHei", sans-serif;  
            margin: 0;  
            padding: 20px;  
            min-height: 100vh;  
            position: relative;  
            overflow-x: hidden;  
        }  
  
        /* ç²’å­èƒŒæ™¯æ•ˆæœ */  
        body.subpage-bg::before {  
            content: '';  
            position: fixed;  
            top: 0;  
            left: 0;  
            width: 100%;  
            height: 100%;  
            background-image:   
                radial-gradient(circle at 20% 50%, rgba(0, 198, 255, 0.1) 0%, transparent 50%),  
                radial-gradient(circle at 80% 80%, rgba(0, 114, 255, 0.1) 0%, transparent 50%),  
                radial-gradient(circle at 40% 20%, rgba(0, 229, 255, 0.1) 0%, transparent 50%);  
            animation: particleFloat 20s ease-in-out infinite;  
            pointer-events: none;  
            z-index: 0;  
        }  
  
        .page-header {  
            display: flex;  
            align-items: center;  
            gap: 20px;  
            margin-bottom: 30px;  
            position: relative;  
            z-index: 1;  
        }  
          
        .back-btn {  
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));  
            border: 2px solid rgba(0, 229, 255, 0.3);  
            color: var(--text-primary);  
            padding: 12px 24px;  
            border-radius: 10px;  
            cursor: pointer;  
            font-size: 14px;  
            font-weight: bold;  
            transition: all 0.3s ease;  
            box-shadow: 0 0 20px rgba(0, 229, 255, 0.3);  
            position: relative;  
            overflow: hidden;  
        }  
          
        .back-btn::before {  
            content: '';  
            position: absolute;  
            top: 50%;  
            left: 50%;  
            width: 0;  
            height: 0;  
            border-radius: 50%;  
            background: rgba(255, 255, 255, 0.2);  
            transform: translate(-50%, -50%);  
            transition: width 0.6s, height 0.6s;  
        }  
          
        .back-btn:hover::before {  
            width: 200px;  
            height: 200px;  
        }  
          
        .back-btn:hover {  
            transform: translateY(-2px);  
            box-shadow: 0 0 30px rgba(0, 229, 255, 0.5);  
            border-color: var(--accent-color);  
        }  
          
        h2 {  
            margin: 0;  
            color: var(--accent-color);  
            font-size: 2rem;  
            text-shadow: 0 0 20px rgba(0, 229, 255, 0.6);  
            animation: glowText 3s infinite alternate;  
        }  
  
        .video-page-container {  
            display: flex;  
            max-width: 1200px;  
            margin: 0 auto;  
            background: var(--glass-bg);  
            border: 1px solid var(--glass-border);  
            border-radius: 20px;  
            box-shadow: 0 0 40px rgba(0, 200, 255, 0.2);  
            backdrop-filter: blur(15px);  
            overflow: hidden;  
            position: relative;  
            z-index: 1;  
        }  
  
        .video-display {  
            flex: 1;  
            padding: 30px;  
            display: flex;  
            flex-direction: column;  
            align-items: center;  
            background: rgba(0, 0, 0, 0.2);  
        }  
  
        .video-display video {  
            border-radius: 15px;  
            box-shadow: 0 0 30px rgba(0, 229, 255, 0.4);  
            margin-bottom: 20px;  
            border: 2px solid var(--glass-border);  
            width: 640px;  /* ç»Ÿä¸€è§†é¢‘æ˜¾ç¤ºå°ºå¯¸ */  
            height: 480px; /* ç»Ÿä¸€è§†é¢‘æ˜¾ç¤ºå°ºå¯¸ */  
            object-fit: contain; /* ä¿æŒè§†é¢‘æ¯”ä¾‹ */  
            background: #000; /* é»‘è‰²èƒŒæ™¯ */  
        }  
  
        .form-section {  
            flex: 1;  
            padding: 30px;  
            background: rgba(255, 255, 255, 0.02);  
            border-left: 1px solid var(--glass-border);  
        }  
  
        .form-group {  
            margin-bottom: 25px;  
        }  
  
        label {  
            display: block;  
            margin-bottom: 10px;  
            font-weight: bold;  
            color: var(--text-primary);  
            font-size: 14px;  
            text-transform: uppercase;  
            letter-spacing: 1px;  
        }  
  
        select, input, textarea {  
            width: 100%;  
            padding: 12px 15px;  
            border: 2px solid var(--glass-border);  
            border-radius: 10px;  
            font-size: 16px;  
            box-sizing: border-box;  
            background: rgba(255, 255, 255, 0.05);  
            color: var(--text-primary);  
            transition: all 0.3s ease;  
        }  
  
        select:focus, input:focus, textarea:focus {  
            outline: none;  
            border-color: var(--accent-color);  
            box-shadow: 0 0 15px rgba(0, 229, 255, 0.3);  
            background: rgba(255, 255, 255, 0.08);  
        }  
  
        select option {  
            background: var(--bg-dark);  
            color: var(--text-primary);  
        }  
  
        textarea {  
            min-height: 100px;  
            resize: vertical;  
        }  
  
        .generate-btn {  
            width: 100%;  
            padding: 15px;  
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));  
            color: var(--text-primary);  
            border: 2px solid rgba(0, 229, 255, 0.3);  
            border-radius: 12px;  
            font-size: 18px;  
            font-weight: bold;  
            cursor: pointer;  
            transition: all 0.3s ease;  
            text-transform: uppercase;  
            letter-spacing: 2px;  
            position: relative;  
            overflow: hidden;  
        }  
  
        .generate-btn::before {  
            content: '';  
            position: absolute;  
            top: 50%;  
            left: 50%;  
            width: 0;  
            height: 0;  
            border-radius: 50%;  
            background: rgba(255, 255, 255, 0.2);  
            transform: translate(-50%, -50%);  
            transition: width 0.6s, height 0.6s;  
        }  
  
        .generate-btn:hover::before {  
            width: 300px;  
            height: 300px;  
        }  
  
        .generate-btn:hover {  
            transform: translateY(-2px);  
            box-shadow: 0 0 30px rgba(0, 229, 255, 0.5);  
            border-color: var(--accent-color);  
        }  
  
        .generate-btn:active {  
            transform: scale(0.98);  
        }  
  
        /* åŠ¨ç”»å®šä¹‰ */  
        @keyframes particleFloat {  
            0%, 100% { transform: translate(0, 0) rotate(0deg); }  
            33% { transform: translate(30px, -30px) rotate(120deg); }  
            66% { transform: translate(-20px, 20px) rotate(240deg); }  
        }  
  
        @keyframes glowText {  
            from {  
                text-shadow: 0 0 20px var(--accent-color);  
                filter: brightness(1);  
            }  
            to {  
                text-shadow: 0 0 35px var(--accent-color), 0 0 60px var(--primary-color);  
                filter: brightness(1.3);  
            }  
        }  
  
        /* å“åº”å¼è®¾è®¡ */  
        @media (max-width: 768px) {  
            .video-page-container {  
                flex-direction: column;  
            }  
  
            .form-section {  
                border-left: none;  
                border-top: 1px solid var(--glass-border);  
            }  
  
            h2 {  
                font-size: 1.5rem;  
            }  
  
            .page-header {  
                flex-direction: column;  
                text-align: center;  
                gap: 15px;  
            }  
        }  
  
        /* åŠ è½½çŠ¶æ€ */  
        .loading-overlay {  
            position: fixed;  
            top: 0;  
            left: 0;  
            width: 100%;  
            height: 100%;  
            background: var(--bg-dark);  
            display: flex;  
            justify-content: center;  
            align-items: center;  
            z-index: 9999;  
            opacity: 0;  
            pointer-events: none;  
            transition: opacity 0.3s ease;  
        }  
  
        .loading-overlay.active {  
            opacity: 1;  
            pointer-events: all;  
        }  
  
        .loading-spinner {  
            width: 50px;  
            height: 50px;  
            border: 3px solid var(--glass-border);  
            border-top: 3px solid var(--primary-color);  
            border-radius: 50%;  
            animation: spin 1s linear infinite;  
        }  
  
        @keyframes spin {  
            0% { transform: rotate(0deg); }  
            100% { transform: rotate(360deg); }  
        }  
        
        /* é”™è¯¯æ ·å¼ */  
        .error-input {  
            border-color: #ff4757 !important;  
            box-shadow: 0 0 10px rgba(255, 71, 87, 0.3) !important;  
        }  
        
        .error-message {  
            color: #ff4757;  
            font-size: 12px;  
            margin-top: 5px;  
            display: none;  
        }  
    </style>  
</head>  
<body class="subpage-bg">  
    <!-- åŠ è½½åŠ¨ç”» -->  
    <div class="loading-overlay" id="loadingOverlay">  
        <div class="loading-spinner"></div>  
    </div>  
  
    <div class="page-header">  
        <button onclick="goHome()" class="back-btn">â† è¿”å›é¦–é¡µ</button>  
        <h2> æ¨¡å‹è®­ç»ƒ</h2>  
    </div>  
  
    <div class="video-page-container">  
        <!-- å·¦ä¾§ï¼šè®­ç»ƒç»“æœè§†é¢‘ -->  
        <div class="video-display">  
            <video id="trainVideo" controls>  
                <source src="{{ url_for('static', filename='videos/sample.mp4') }}" type="video/mp4">  
                æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒ video æ ‡ç­¾ã€‚  
            </video>  
            <div id="videoStatus" style="text-align: center; color: var(--accent-color); font-size: 14px; margin-top: 10px;">  
                å‡†å¤‡è®­ç»ƒæ¨¡å‹  
            </div>  
        </div>  
  
        <!-- å³ä¾§ï¼šè¾“å…¥æ¡† -->  
        <div class="form-section">  
            <form id="trainForm">  
                <div class="form-group">  
                    <label>æ¨¡å‹é€‰æ‹©</label>  
                    <select name="model_choice" id="model_choice" onchange="toggleEpochField()">  
                        <!-- æ·»åŠ ï¼šTalkingGaussian é€‰é¡¹ -->  
                        <option value="TalkingGaussian">TalkingGaussian</option>  
                        <option value="SyncTalk">SyncTalk</option>  
                    </select>  
                </div>  
  
                <div class="form-group">  
                    <label>å‚è€ƒè§†é¢‘/å›¾åƒåœ°å€ <span style="color: #ff4757;">*</span></label>  
                    <input type="text" name="ref_video" id="ref_video" placeholder="è¯·è¾“å…¥å‚è€ƒè§†é¢‘æˆ–å›¾åƒçš„ç›¸å¯¹è·¯å¾„" required>  
                    <div id="ref_video_error" class="error-message">è¯·è¾“å…¥å‚è€ƒè§†é¢‘/å›¾åƒåœ°å€</div>  
                    <small style="color: var(--text-secondary); font-size: 12px; display: block; margin-top: 5px;">  
                        æ¨èï¼šstatic/uploads/videos/May.mp4ï¼ˆç³»ç»Ÿä¼šè‡ªåŠ¨å¤åˆ¶åˆ°è®­ç»ƒç›®å½•ï¼‰<br>
                        æˆ–ï¼šTalkingGaussian/data/May/May.mp4  
                    </small>  
                </div>  
  
                <div class="form-group">  
                    <label>GPUé€‰æ‹©</label>  
                    <select name="gpu_choice">  
                        <option value="GPU0">GPU 0</option>  
                        <option value="GPU1">GPU 1</option>  
                    </select>  
                </div>  
  
                <div class="form-group" id="epoch_group" style="display: none;">  
                    <label>Epochï¼ˆè®­ç»ƒè½®æ•°ï¼‰</label>  
                    <input type="number" name="epoch" id="epoch" min="1" value="10">  
                    <small style="color: var(--text-secondary); font-size: 12px; display: block; margin-top: 5px;">  
                        æ­¤å‚æ•°ä»…å¯¹ SyncTalk æ¨¡å‹æœ‰æ•ˆã€‚TalkingGaussian ä½¿ç”¨å›ºå®šè®­ç»ƒç­–ç•¥ã€‚  
                    </small>  
                </div>  
  
                <div class="form-group">  
                    <label>è‡ªå®šä¹‰è®­ç»ƒå‚æ•°</label>  
                    <textarea name="custom_params" placeholder="è¯·è¾“å…¥è‡ªå®šä¹‰å‚æ•°..."></textarea>  
                </div>  
  
                <!-- æ·»åŠ ï¼šè®­ç»ƒç»“æœå±•ç¤ºåŒºåŸŸ -->  
                <div id="training_result" style="display: none; margin-top: 20px; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 10px; border: 1px solid var(--glass-border);">  
                    <h3 style="margin-top: 0; color: var(--accent-color);">è®­ç»ƒå®Œæˆ</h3>  
                    <div class="form-group">  
                        <label>æ¨¡å‹è·¯å¾„ï¼š</label>  
                        <div style="display: flex; gap: 10px; align-items: center;">  
                            <input type="text"  
                                   id="model_path_output"  
                                   readonly  
                                   style="flex: 1; padding: 8px; border: 1px solid var(--glass-border); border-radius: 8px; background: rgba(255,255,255,0.1); color: var(--text-primary);">  
                            <button type="button" onclick="copyModelPath()" style="padding: 8px 15px; border: 1px solid var(--glass-border); border-radius: 8px; background: rgba(0,198,255,0.2); color: var(--text-primary); cursor: pointer;">å¤åˆ¶</button>  
                        </div>  
                        <small style="color: var(--text-secondary); font-size: 12px; display: block; margin-top: 5px;">  
                            æ­¤è·¯å¾„å¯ç”¨äºè§†é¢‘ç”Ÿæˆå’Œå®æ—¶å¯¹è¯ä¸­çš„"æ¨¡å‹å‚æ•°"å­—æ®µ  
                        </small>  
                    </div>  
                </div>  
  
                <button type="submit" class="generate-btn">ğŸš€ Training!</button>  
            </form>  
        </div>  
    </div>  
  
    <script>  
        // è¿”å›é¦–é¡µå‡½æ•°  
        function goHome() {  
            // æ˜¾ç¤ºåŠ è½½åŠ¨ç”»  
            const loadingOverlay = document.getElementById('loadingOverlay');  
            loadingOverlay.classList.add('active');  
  
            // æ¸…é™¤å¯èƒ½çš„ç¼“å­˜é—®é¢˜  
            if ('serviceWorker' in navigator) {  
                navigator.serviceWorker.getRegistrations().then(function(registrations) {  
                    for(let registration of registrations) {  
                        registration.unregister();  
                    }  
                });  
            }  
  
            // å¼ºåˆ¶åˆ·æ–°é¦–é¡µ  
            setTimeout(() => {  
                window.location.href = '/?t=' + new Date().getTime();  
            }, 300);  
        }  
  
        // EPOCHå­—æ®µæ˜¾ç¤º/éšè—æ§åˆ¶  
        function toggleEpochField() {  
            const modelChoice = document.getElementById('model_choice').value;  
            const epochGroup = document.getElementById('epoch_group');  
  
            if (modelChoice === 'SyncTalk') {  
                epochGroup.style.display = 'block';  
            } else {  
                epochGroup.style.display = 'none';  
            }  
        }  
  
        // å¤åˆ¶æ¨¡å‹è·¯å¾„  
        function copyModelPath() {  
            const modelPathInput = document.getElementById('model_path_output');  
            modelPathInput.select();  
            document.execCommand('copy');  
            showNotification('æ¨¡å‹è·¯å¾„å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');  
        }  
  
        // æ›´æ–°è§†é¢‘çŠ¶æ€æ˜¾ç¤º  
        function updateVideoStatus(status, isError = false) {  
            const statusEl = document.getElementById('videoStatus');  
            if (statusEl) {  
                statusEl.textContent = status;  
                statusEl.style.color = isError ? '#ff4757' : 'var(--accent-color)';  
            }  
        }  
  
        // é‡ç½®è§†é¢‘æ˜¾ç¤º  
        function resetVideoDisplay() {  
            const videoEl = document.getElementById('trainVideo');  
            const statusEl = document.getElementById('videoStatus');  
            
            // é‡ç½®è§†é¢‘æºåˆ°é»˜è®¤  
            const defaultSrc = "{{ url_for('static', filename='videos/sample.mp4') }}";  
            videoEl.src = defaultSrc + '?t=' + new Date().getTime();  
            videoEl.load();  
            
            // é‡ç½®çŠ¶æ€æ˜¾ç¤º  
            if (statusEl) {  
                statusEl.textContent = 'å‡†å¤‡è®­ç»ƒæ¨¡å‹';  
                statusEl.style.color = 'var(--accent-color)';  
            }  
        }  
  
        // æ˜¾ç¤ºè¡¨å•é”™è¯¯  
        function showInputError(inputId, message) {  
            const input = document.getElementById(inputId);  
            const errorDiv = document.getElementById(inputId + '_error');  
            
            if (input && errorDiv) {  
                input.classList.add('error-input');  
                errorDiv.textContent = message;  
                errorDiv.style.display = 'block';  
            }  
        }  
  
        // æ¸…é™¤è¡¨å•é”™è¯¯  
        function clearInputError(inputId) {  
            const input = document.getElementById(inputId);  
            const errorDiv = document.getElementById(inputId + '_error');  
            
            if (input && errorDiv) {  
                input.classList.remove('error-input');  
                errorDiv.style.display = 'none';  
            }  
        }  
  
        // è¡¨å•éªŒè¯  
        function validateForm() {  
            let isValid = true;  
            
            // éªŒè¯å‚è€ƒè§†é¢‘åœ°å€  
            const refVideoInput = document.getElementById('ref_video');  
            const refVideoValue = refVideoInput.value.trim();  
            
            if (!refVideoValue) {  
                showInputError('ref_video', 'è¯·è¾“å…¥å‚è€ƒè§†é¢‘/å›¾åƒåœ°å€');  
                isValid = false;  
            } else {  
                clearInputError('ref_video');  
            }  
            
            // å¦‚æœé€‰æ‹©SyncTalkï¼ŒéªŒè¯epoch  
            const modelChoice = document.getElementById('model_choice').value;  
            if (modelChoice === 'SyncTalk') {  
                const epochInput = document.getElementById('epoch');  
                const epochValue = parseInt(epochInput.value);  
                
                if (isNaN(epochValue) || epochValue < 1) {  
                    showInputError('epoch', 'è¯·è¾“å…¥æœ‰æ•ˆçš„è®­ç»ƒè½®æ•°ï¼ˆå¤§äº0ï¼‰');  
                    isValid = false;  
                } else {  
                    clearInputError('epoch');  
                }  
            }  
            
            return isValid;  
        }  
  
            document.getElementById('trainForm').addEventListener('submit', function (e) {
        e.preventDefault();

        // éªŒè¯è¡¨å•
        if (!validateForm()) {
            showNotification('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µ', 'error');
            return;
        }

        const formData = new FormData(this);

        // æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
        const loadingOverlay = document.getElementById('loadingOverlay');
        loadingOverlay.classList.add('active');

        // æ›´æ–°çŠ¶æ€
        updateVideoStatus('æ­£åœ¨è®­ç»ƒæ¨¡å‹...');

        // ç«‹å³ä»è¡¨å•è·å–è§†é¢‘è·¯å¾„å¹¶æ’­æ”¾
        const refVideoPath = formData.get('ref_video');
        const videoEl = document.getElementById('trainVideo');

        if (refVideoPath) {
            // ç«‹å³è®¾ç½®è§†é¢‘æºå¹¶æ’­æ”¾
            const newSrc = "/" + refVideoPath.replace("\\", "/") + '?t=' + new Date().getTime();
            videoEl.src = newSrc;
            videoEl.load();
            videoEl.play().catch(e => console.log('è‡ªåŠ¨æ’­æ”¾å¯èƒ½è¢«é˜»æ­¢:', e));
        }

        let trainingData = null; // ç”¨äºåœ¨finallyä¸­è®¿é—®
        
        fetch('/model_training', {
            method: 'POST',
            body: formData
        })
            .then(res => {
                if (!res.ok) {
                    throw new Error(`HTTPé”™è¯¯: ${res.status}`);
                }
                return res.json();
            })
            .then(data => {
                trainingData = data; // ä¿å­˜æ•°æ®
                console.log("åç«¯è¿”å›æ•°æ®:", data);

                // å¦‚æœè®­ç»ƒå·²å¼€å§‹ï¼Œå¼€å§‹è½®è¯¢çŠ¶æ€
                if (data.status === 'started' && data.task_id) {
                    updateVideoStatus('è®­ç»ƒå·²å¼€å§‹ï¼Œæ­£åœ¨è¿›è¡Œä¸­...');
                    showNotification('è®­ç»ƒå·²å¼€å§‹ï¼Œè¯·ç¨å€™...', 'success');
                    // å¼€å§‹è½®è¯¢è®­ç»ƒçŠ¶æ€
                    pollTrainingStatus(data.task_id);
                    return;
                }

                if (data.status === 'success') {
                    // æ£€æŸ¥è¿”å›çš„æ˜¯å¦æ˜¯æœ‰æ•ˆçš„æ¨¡å‹è·¯å¾„
                    const returnedPath = data.model_path || data.video_path || '';

                    // æ¨¡å‹è·¯å¾„çš„ç‰¹å¾ï¼šåŒ…å«output/ ä¸”ä¸ä»¥.mp4ç»“å°¾
                    if (returnedPath.includes('output/') &&
                        !returnedPath.endsWith('.mp4') &&
                        !returnedPath.endsWith('.avi') &&
                        !returnedPath.endsWith('.mov')) {

                        // è®­ç»ƒæˆåŠŸï¼šåœæ­¢æ’­æ”¾è§†é¢‘ï¼Œæ˜¾ç¤ºè®­ç»ƒå®Œæˆç”»é¢
                        videoEl.pause();
                        videoEl.currentTime = 0;

                        // å¯ä»¥æ˜¾ç¤ºä¸€ä¸ªè®­ç»ƒå®Œæˆçš„é™æ€å›¾åƒæˆ–æç¤º
                        // è¿™é‡Œæˆ‘ä»¬ä¿æŒè§†é¢‘ä¸ºå‚è€ƒè§†é¢‘ï¼Œä½†æš‚åœåœ¨å¼€å¤´

                        document.getElementById('model_path_output').value = returnedPath;
                        document.getElementById('training_result').style.display = 'block';
                        updateVideoStatus('è®­ç»ƒå®Œæˆï¼æ¨¡å‹è·¯å¾„: ' + returnedPath);
                        showNotification('è®­ç»ƒå®Œæˆï¼', 'success');

                    } else if (returnedPath.includes('TalkingGaussian/data/') ||
                               returnedPath.endsWith('.mp4')) {
                        // è®­ç»ƒå¤±è´¥
                        console.warn('è®­ç»ƒå¤±è´¥ï¼Œè¿”å›äº†è§†é¢‘è·¯å¾„:', returnedPath);
                        resetVideoDisplay();
                        updateVideoStatus('è®­ç»ƒå¤±è´¥ï¼šè¯·æ£€æŸ¥æ–‡ä»¶è·¯å¾„å’Œé¢„å¤„ç†', true);
                        showNotification('è®­ç»ƒå¤±è´¥ï¼šè¯·æ£€æŸ¥å‚è€ƒè§†é¢‘è·¯å¾„å’Œé¢„å¤„ç†é…ç½®', 'error');
                    } else {
                        // å…¶ä»–æƒ…å†µ
                        if (data.message && (data.message.includes('å¤±è´¥') ||
                            data.message.includes('é”™è¯¯') ||
                            data.message.includes('not found'))) {
                            resetVideoDisplay();
                            updateVideoStatus('è®­ç»ƒå¤±è´¥: ' + data.message, true);
                            showNotification('è®­ç»ƒå¤±è´¥ï¼š' + data.message, 'error');
                        } else {
                            // é»˜è®¤æˆåŠŸ
                            videoEl.pause();
                            videoEl.currentTime = 0;
                            document.getElementById('model_path_output').value = returnedPath || 'æœªçŸ¥è·¯å¾„';
                            document.getElementById('training_result').style.display = 'block';
                            updateVideoStatus('è®­ç»ƒå®Œæˆï¼', true);
                            showNotification('è®­ç»ƒå®Œæˆï¼', 'success');
                        }
                    }
                } else if (data.status === 'error') {
                    // åç«¯æ˜ç¡®è¿”å›é”™è¯¯
                    resetVideoDisplay();
                    updateVideoStatus('è®­ç»ƒå¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯'), true);
                    showNotification('è®­ç»ƒå¤±è´¥ï¼š' + (data.message || 'æœªçŸ¥é”™è¯¯'), 'error');
                } else {
                    // æ²¡æœ‰statuså­—æ®µæˆ–å…¶ä»–æƒ…å†µ
                    resetVideoDisplay();
                    updateVideoStatus('è®­ç»ƒå¤±è´¥ï¼šæœåŠ¡å™¨è¿”å›æ•°æ®æ ¼å¼å¼‚å¸¸', true);
                    showNotification('è®­ç»ƒå¤±è´¥ï¼šæœåŠ¡å™¨è¿”å›æ•°æ®æ ¼å¼å¼‚å¸¸', 'error');
                }
            })
            .catch(err => {
                console.error('è¯·æ±‚é”™è¯¯:', err);
                resetVideoDisplay();
                updateVideoStatus('è¯·æ±‚é”™è¯¯ï¼š' + err.message, true);
                showNotification('è®­ç»ƒå¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–æœåŠ¡å™¨çŠ¶æ€', 'error');
            })
            .finally(() => {
                // æ³¨æ„ï¼šå¼‚æ­¥è®­ç»ƒæ—¶ä¸è¦ç«‹å³éšè—åŠ è½½åŠ¨ç”»
                // åªæœ‰åœ¨åŒæ­¥è®­ç»ƒå®Œæˆæ—¶æ‰éšè—
                if (trainingData && trainingData.status !== 'started') {
                setTimeout(() => {
                    loadingOverlay.classList.remove('active');
                }, 500);
                }
            });
    });

        // è½®è¯¢è®­ç»ƒçŠ¶æ€
        function pollTrainingStatus(taskId) {
            // TalkingGaussianè®­ç»ƒåŒ…å«ä¸‰ä¸ªé˜¶æ®µï¼Œæ¯ä¸ªé˜¶æ®µ50kè¿­ä»£ï¼Œæ€»è®¡çº¦110kè¿­ä»£
            // è®­ç»ƒæ—¶é—´å–å†³äºGPUæ€§èƒ½ï¼šé«˜ç«¯GPU(å¦‚A100)çº¦2-4å°æ—¶ï¼Œä¸­ç«¯GPU(å¦‚RTX 3090)çº¦4-8å°æ—¶ï¼Œä½ç«¯GPUå¯èƒ½éœ€è¦8-12å°æ—¶
            // è®¾ç½®æœ€å¤§è½®è¯¢æ—¶é—´ä¸º24å°æ—¶ï¼ˆ17280æ¬¡ï¼Œæ¯5ç§’ä¸€æ¬¡ï¼‰ï¼Œç¡®ä¿è¦†ç›–æ‰€æœ‰å¯èƒ½çš„è®­ç»ƒæ—¶é—´
            const maxAttempts = 17280; // 24å°æ—¶ = 86400ç§’ / 5ç§’ = 17280æ¬¡
            let attempts = 0;
            const pollInterval = 5000; // æ¯5ç§’è½®è¯¢ä¸€æ¬¡

            // æ ¼å¼åŒ–æ—¶é—´æ˜¾ç¤º
            function formatTime(seconds) {
                const hours = Math.floor(seconds / 3600);
                const minutes = Math.floor((seconds % 3600) / 60);
                const secs = seconds % 60;
                if (hours > 0) {
                    return `${hours}å°æ—¶${minutes}åˆ†é’Ÿ${secs}ç§’`;
                } else if (minutes > 0) {
                    return `${minutes}åˆ†é’Ÿ${secs}ç§’`;
                } else {
                    return `${secs}ç§’`;
                }
            }

            const poll = () => {
                const elapsedSeconds = Math.floor(attempts * pollInterval / 1000);
                
                // åªåœ¨è¶…è¿‡24å°æ—¶æ—¶æ‰è¶…æ—¶ï¼ˆå®é™…è®­ç»ƒå¯èƒ½æ›´é•¿ï¼Œä½†è‡³å°‘ç»™è¶³å¤Ÿæ—¶é—´ï¼‰
                if (attempts >= maxAttempts) {
                    updateVideoStatus('è®­ç»ƒæ—¶é—´è¶…è¿‡24å°æ—¶ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨æ—¥å¿—æˆ–æ‰‹åŠ¨æŸ¥çœ‹è®­ç»ƒçŠ¶æ€', true);
                    showNotification('è®­ç»ƒæ—¶é—´è¾ƒé•¿ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨æ—¥å¿—ç¡®è®¤è®­ç»ƒæ˜¯å¦ä»åœ¨è¿›è¡Œ', 'warning');
                    // ä¸åœæ­¢è½®è¯¢ï¼Œç»§ç»­å°è¯•è·å–çŠ¶æ€ï¼ˆå¯èƒ½è®­ç»ƒä»åœ¨è¿›è¡Œï¼‰
                    // ä½†é™ä½è½®è¯¢é¢‘ç‡åˆ°æ¯30ç§’ä¸€æ¬¡
                    setTimeout(poll, 30000);
                    return;
                }

                fetch(`/training_status/${taskId}`)
                    .then(res => res.json())
                    .then(data => {
                        console.log("è®­ç»ƒçŠ¶æ€:", data);

                        if (data.status === 'completed') {
                            // è®­ç»ƒå®Œæˆ
                            const videoEl = document.getElementById('trainVideo');
                            videoEl.pause();
                            videoEl.currentTime = 0;

                            document.getElementById('model_path_output').value = data.model_path || '';
                            document.getElementById('training_result').style.display = 'block';
                            updateVideoStatus('è®­ç»ƒå®Œæˆï¼æ¨¡å‹è·¯å¾„: ' + (data.model_path || '') + ` (æ€»è€—æ—¶: ${formatTime(elapsedSeconds)})`);
                            showNotification('è®­ç»ƒå®Œæˆï¼', 'success');
                            document.getElementById('loadingOverlay').classList.remove('active');
                        } else if (data.status === 'error') {
                            // è®­ç»ƒå¤±è´¥
                            resetVideoDisplay();
                            updateVideoStatus('è®­ç»ƒå¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯'), true);
                            showNotification('è®­ç»ƒå¤±è´¥ï¼š' + (data.message || 'æœªçŸ¥é”™è¯¯'), 'error');
                            document.getElementById('loadingOverlay').classList.remove('active');
                        } else {
                            // è®­ç»ƒè¿›è¡Œä¸­ï¼Œç»§ç»­è½®è¯¢
                            attempts++;
                            
                            // æ ¹æ®è®­ç»ƒæ—¶é—´æ˜¾ç¤ºä¸åŒçš„æç¤ºä¿¡æ¯
                            let statusMessage = `è®­ç»ƒè¿›è¡Œä¸­... (å·²ç­‰å¾… ${formatTime(elapsedSeconds)})`;
                            if (elapsedSeconds < 1800) { // 30åˆ†é’Ÿå†…
                                statusMessage += '\nè®­ç»ƒåˆšå¼€å§‹ï¼Œè¯·è€å¿ƒç­‰å¾…';
                            } else if (elapsedSeconds < 7200) { // 2å°æ—¶å†…
                                statusMessage += '\nè®­ç»ƒæ­£å¸¸è¿›è¡Œä¸­';
                            } else if (elapsedSeconds < 14400) { // 4å°æ—¶å†…
                                statusMessage += '\nè®­ç»ƒå¯èƒ½éœ€è¦è¾ƒé•¿æ—¶é—´ï¼Œè¯·ç»§ç»­ç­‰å¾…';
                            } else { // è¶…è¿‡4å°æ—¶
                                statusMessage += '\nè®­ç»ƒæ—¶é—´è¾ƒé•¿ï¼Œè¿™æ˜¯æ­£å¸¸çš„ï¼Œè¯·ç»§ç»­ç­‰å¾…';
                            }
                            
                            updateVideoStatus(statusMessage);
                            setTimeout(poll, pollInterval);
                        }
                    })
                    .catch(err => {
                        console.error('è½®è¯¢é”™è¯¯:', err);
                        attempts++;
                        if (attempts < maxAttempts) {
                            // ç½‘ç»œé”™è¯¯æ—¶ï¼Œå»¶é•¿è½®è¯¢é—´éš”åˆ°10ç§’
                            setTimeout(poll, 10000);
                        } else {
                            updateVideoStatus('æ— æ³•è·å–è®­ç»ƒçŠ¶æ€ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨è¿æ¥', true);
                            showNotification('æ— æ³•è·å–è®­ç»ƒçŠ¶æ€ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨è¿æ¥', 'error');
                            document.getElementById('loadingOverlay').classList.remove('active');
                        }
                    });
            };

            // å¼€å§‹è½®è¯¢
            setTimeout(poll, pollInterval);
        }

  
        // é€šçŸ¥æç¤ºå‡½æ•°  
        function showNotification(message, type) {  
            const notification = document.createElement('div');  
            notification.style.cssText = `  
                position: fixed;  
                top: 20px;  
                right: 20px;  
                padding: 15px 25px;  
                background: ${type === 'success' ? 'linear-gradient(135deg, #00c6ff, #0072ff)' : 'linear-gradient(135deg, #ff4757, #ff6348)'};  
                color: white;  
                border-radius: 10px;  
                box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);  
                z-index: 10000;  
                animation: slideIn 0.3s ease;  
                font-weight: bold;  
            `;  
            notification.textContent = message;  
  
            document.body.appendChild(notification);  
  
            setTimeout(() => {  
                notification.style.animation = 'slideOut 0.3s ease';  
                setTimeout(() => notification.remove(), 300);  
            }, 3000);  
        }  
  
        // æ·»åŠ åŠ¨ç”»æ ·å¼  
        const style = document.createElement('style');  
        style.textContent = `  
            @keyframes slideIn {  
                from { transform: translateX(100%); opacity: 0; }  
                to { transform: translateX(0); opacity: 1; }  
            }  
            @keyframes slideOut {  
                from { transform: translateX(0); opacity: 1; }  
                to { transform: translateX(100%); opacity: 0; }  
            }  
        `;  
        document.head.appendChild(style);  
  
       // é¡µé¢åŠ è½½å®Œæˆåéšè—åŠ è½½åŠ¨ç”»  
        document.addEventListener('DOMContentLoaded', function() {  
            const body = document.body;  
            // æ¢å¤ä¸»é¢˜è®¾ç½®  
            const savedTheme = localStorage.getItem('theme');  
            if (savedTheme === 'light') {  
                body.classList.add('light-theme');  
            }  
  
            // åˆå§‹åŒ–EPOCHå­—æ®µçŠ¶æ€  
            toggleEpochField();  
  
            // ç›‘å¬è¾“å…¥æ¡†å˜åŒ–ï¼Œæ¸…é™¤é”™è¯¯çŠ¶æ€  
            const refVideoInput = document.getElementById('ref_video');  
            if (refVideoInput) {  
                refVideoInput.addEventListener('input', function() {  
                    if (this.value.trim()) {  
                        clearInputError('ref_video');  
                    }  
                });  
            }  
            
            const epochInput = document.getElementById('epoch');  
            if (epochInput) {  
                epochInput.addEventListener('input', function() {  
                    const value = parseInt(this.value);  
                    if (!isNaN(value) && value > 0) {  
                        clearInputError('epoch');  
                    }  
                });  
            }  
  
            // æ¢å¤å…¨å±çŠ¶æ€  
            const wasFullscreen = localStorage.getItem('isFullscreen') === 'true';  
            if (wasFullscreen && !document.fullscreenElement) {  
                // å¦‚æœä¹‹å‰æ˜¯å…¨å±çŠ¶æ€ï¼Œè‡ªåŠ¨è¿›å…¥å…¨å±  
                document.documentElement.requestFullscreen().catch(e => {  
                    console.log('è‡ªåŠ¨å…¨å±å¤±è´¥:', e);  
                const restoreFullscreen = () => {  
                document.documentElement.requestFullscreen().catch(e => console.error(e));  
                // ç§»é™¤ç›‘å¬å™¨ï¼Œç¡®ä¿åªè§¦å‘ä¸€æ¬¡  
                document.removeEventListener('click', restoreFullscreen);  
                document.removeEventListener('touchstart', restoreFullscreen);  
            };  
  
            // ç›‘å¬ç‚¹å‡»å’Œè§¦æ‘¸ï¼ˆé€‚é…ç§»åŠ¨ç«¯ï¼‰  
            document.addEventListener('click', restoreFullscreen, { once: true });  
            document.addEventListener('touchstart', restoreFullscreen, { once: true });  
  
  
           showNotification('ç‚¹å‡»ä»»æ„ä½ç½®æ¢å¤å…¨å±', 'info');  
        });  
    }  
  
            // ç›‘å¬å…¨å±çŠ¶æ€å˜åŒ–  
            document.addEventListener('fullscreenchange', function() {  
                const isFullscreen = !!document.fullscreenElement;  
                localStorage.setItem('isFullscreen', isFullscreen.toString());  
            });  
  
        });  
    </script>  
</body>  
</html>