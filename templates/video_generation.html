<!DOCTYPE html>
<html lang="zh">  
<head>  
    <meta charset="UTF-8">  
    <meta name="viewport" content="width=device-width, initial-scale=1.0">  
    <title>视频生成界面</title>  
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">  
    <style>  
        :root {  
            --primary-color: #00c6ff;  
            --secondary-color: #0072ff;  
            --accent-color: #00e5ff;  
            --bg-dark: #0a0a0a;  
            --bg-light: #1b1b1b;  
            --text-primary: #ffffff;  
            --text-secondary: rgba(255, 255, 255, 0.7);  
            --glass-bg: rgba(255, 255, 255, 0.05);  
            --glass-border: rgba(255, 255, 255, 0.2);  
            --neon-glow: rgba(0, 229, 255, 0.8);  
        }  
          /* 浅色主题变量 - 使用新的紫色系配色 */  
        body.light-theme {  
            --primary-color: #6366f1;  
            --secondary-color: #8b5cf6;  
            --accent-color: #06b6d4;  
            --bg-dark: #f8fafc;  
            --bg-light: #ffffff;  
            --text-primary: #1e293b;  
            --text-secondary: rgba(30, 41, 59, 0.7);  
            --glass-bg: rgba(255, 255, 255, 0.9);  
            --glass-border: rgba(99, 102, 241, 0.2);  
        }  
        
        /* 浅色模式背景 */  
        body.light-theme.subpage-bg {  
            background: radial-gradient(circle at top left, #e0e7ff 0%, #ffffff 50%, #f3f4f6 100%);  
        }  
        
        /* 浅色模式粒子层 */  
        body.light-theme.subpage-bg::before {  
            opacity: 0.6;  
            filter: hue-rotate(20deg);  
            mix-blend-mode: multiply;  
        }  
        
        /* 浅色模式3D网格线 */  
        body.light-theme.subpage-bg::after {  
            opacity: 0.4;  
            background:   
                linear-gradient(45deg, transparent 40%, rgba(99, 102, 241, 0.05) 50%, transparent 60%),  
                linear-gradient(-45deg, transparent 40%, rgba(6, 182, 212, 0.05) 50%, transparent 60%);  
        }  
        
        /* 浅色模式容器 */  
        body.light-theme .video-page-container {  
            background: rgba(255, 255, 255, 0.65);  
            border: 1px solid rgba(255, 255, 255, 0.8);  
            box-shadow: 0 20px 50px rgba(99, 102, 241, 0.1);  
            backdrop-filter: blur(20px) saturate(180%);  
        }  
        
        /* 浅色模式返回按钮 */  
        body.light-theme .back-btn {  
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);  
            border: 1px solid rgba(255, 255, 255, 0.4);  
            color: white;  
            box-shadow: 0 10px 20px rgba(99, 102, 241, 0.3);  
        }  
        
        body.light-theme .back-btn:hover {  
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);  
            box-shadow: 0 15px 30px rgba(124, 58, 237, 0.4);  
        }  
        
        /* 浅色模式标题 */  
        body.light-theme h2 {  
            background: linear-gradient(135deg, #4f46e5, #06b6d4);  
            -webkit-background-clip: text;  
            background-clip: text;  
            -webkit-text-fill-color: transparent;  
            text-shadow: none;  
            filter: drop-shadow(0 2px 10px rgba(99, 102, 241, 0.2));  
        }  
        
        /* 浅色模式表单元素 */  
        body.light-theme select,  
        body.light-theme input,  
        body.light-theme textarea {  
            background: rgba(255, 255, 255, 0.8);  
            border-color: rgba(99, 102, 241, 0.2);  
            color: var(--text-primary);  
        }  
        
        /* 浅色模式生成按钮 */  
        body.light-theme .generate-btn {  
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);  
            border: 1px solid rgba(255, 255, 255, 0.4);  
            box-shadow: 0 10px 20px rgba(99, 102, 241, 0.3);  
        }  
        
        body.light-theme .generate-btn:hover {  
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);  
            box-shadow: 0 15px 30px rgba(124, 58, 237, 0.4);  
        }
        body.subpage-bg {  
            background: radial-gradient(circle at center, var(--bg-dark) 0%, var(--bg-light) 100%);  
            color: var(--text-primary);  
            font-family: "Segoe UI", "Microsoft YaHei", sans-serif;  
            margin: 0;  
            padding: 20px;  
            min-height: 100vh;  
            position: relative;  
            overflow-x: hidden;  
        }  
  
        /* 粒子背景效果 */  
        body.subpage-bg::before {  
            content: '';  
            position: fixed;  
            top: 0;  
            left: 0;  
            width: 100%;  
            height: 100%;  
            background-image:   
                radial-gradient(circle at 20% 50%, rgba(0, 198, 255, 0.1) 0%, transparent 50%),  
                radial-gradient(circle at 80% 80%, rgba(0, 114, 255, 0.1) 0%, transparent 50%),  
                radial-gradient(circle at 40% 20%, rgba(0, 229, 255, 0.1) 0%, transparent 50%);  
            animation: particleFloat 20s ease-in-out infinite;  
            pointer-events: none;  
            z-index: 0;  
        }  
  
        /* 3D旋转几何图形背景 */  
        body.subpage-bg::after {  
            content: '';  
            position: fixed;  
            top: 0;  
            left: 0;  
            width: 100%;  
            height: 100%;  
            background:   
                linear-gradient(45deg, transparent 40%, rgba(0, 229, 255, 0.02) 50%, transparent 60%),  
                linear-gradient(-45deg, transparent 40%, rgba(0, 198, 255, 0.02) 50%, transparent 60%),  
                linear-gradient(90deg, transparent 40%, rgba(0, 114, 255, 0.01) 50%, transparent 60%);  
            animation: rotateGeometry3D 35s linear infinite;  
            transform-style: preserve-3d;  
            pointer-events: none;  
            z-index: 0;  
        }  
  
        .page-header {  
            display: flex;  
            align-items: center;  
            gap: 20px;  
            margin-bottom: 30px;  
            position: relative;  
            z-index: 1;  
        }  
          
        .back-btn {  
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));  
            border: 2px solid rgba(0, 229, 255, 0.3);  
            color: var(--text-primary);  
            padding: 12px 24px;  
            border-radius: 10px;  
            cursor: pointer;  
            font-size: 14px;  
            font-weight: bold;  
            transition: all 0.3s ease;  
            box-shadow: 0 0 20px rgba(0, 229, 255, 0.3);  
            position: relative;  
            overflow: hidden;  
        }  
          
        .back-btn::before {  
            content: '';  
            position: absolute;  
            top: 50%;  
            left: 50%;  
            width: 0;  
            height: 0;  
            border-radius: 50%;  
            background: rgba(255, 255, 255, 0.2);  
            transform: translate(-50%, -50%);  
            transition: width 0.6s, height 0.6s;  
        }  
          
        .back-btn:hover::before {  
            width: 200px;  
            height: 200px;  
        }  
          
        .back-btn:hover {  
            transform: translateY(-2px);  
            box-shadow: 0 0 30px rgba(0, 229, 255, 0.5);  
            border-color: var(--accent-color);  
        }  
          
        h2 {  
            margin: 0;  
            color: var(--accent-color);  
            font-size: 2rem;  
            text-shadow: 0 0 20px rgba(0, 229, 255, 0.6);  
            animation: glowText 3s infinite alternate;  
        }  
  
        .video-page-container {  
            display: flex;  
            max-width: 1200px;  
            margin: 0 auto;  
            background: var(--glass-bg);  
            border: 1px solid var(--glass-border);  
            border-radius: 20px;  
            box-shadow: 0 0 40px rgba(0, 200, 255, 0.2);  
            backdrop-filter: blur(15px);  
            overflow: hidden;  
            position: relative;  
            z-index: 1;  
        }  
  
        .video-display {  
            flex: 1;  
            padding: 30px;  
            display: flex;  
            flex-direction: column;  
            align-items: center;  
            background: rgba(0, 0, 0, 0.2);  
        }  
  
        .video-display video {  
            border-radius: 15px;  
            box-shadow: 0 0 30px rgba(0, 229, 255, 0.4);  
            margin-bottom: 20px;  
            border: 2px solid var(--glass-border);  
            width: 640px;  /* 添加：统一视频显示尺寸 */  
            height: 480px; /* 添加：统一视频显示尺寸 */  
            object-fit: contain; /* 添加：保持视频比例 */  
            background: #000; /* 添加：黑色背景 */  
        }  
  
        .form-section {  
            flex: 1;  
            padding: 30px;  
            background: rgba(255, 255, 255, 0.02);  
            border-left: 1px solid var(--glass-border);  
        }  
  
        .form-group {  
            margin-bottom: 25px;  
        }  
  
        label {  
            display: block;  
            margin-bottom: 10px;  
            font-weight: bold;  
            color: var(--text-primary);  
            font-size: 14px;  
            text-transform: uppercase;  
            letter-spacing: 1px;  
        }  
  
        input, select, textarea {  
            width: 100%;  
            padding: 12px 15px;  
            border: 2px solid var(--glass-border);  
            border-radius: 10px;  
            background: rgba(255, 255, 255, 0.05);  
            color: var(--text-primary);  
            font-size: 16px;  
            box-sizing: border-box;  
            transition: all 0.3s ease;  
        }  
  
        input:focus, select:focus, textarea:focus {  
            outline: none;  
            border-color: var(--accent-color);  
            box-shadow: 0 0 15px rgba(0, 229, 255, 0.3);  
            background: rgba(255, 255, 255, 0.08);  
        }  
  
        select option {  
            background: var(--bg-dark);  
            color: var(--text-primary);  
        }  
  
        textarea {  
            height: 100px;  
            resize: vertical;  
        }  
  
        .generate-btn {  
            width: 100%;  
            padding: 15px;  
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));  
            border: 2px solid rgba(0, 229, 255, 0.3);  
            color: var(--text-primary);  
            border-radius: 12px;  
            font-size: 16px;  
            font-weight: bold;  
            cursor: pointer;  
            transition: all 0.3s ease;  
            box-shadow: 0 0 20px rgba(0, 229, 255, 0.3);  
            text-transform: uppercase;  
            letter-spacing: 1px;  
        }  
  
        .generate-btn:hover {  
            transform: translateY(-2px);  
            box-shadow: 0 0 30px rgba(0, 229, 255, 0.5);  
            border-color: var(--accent-color);  
        }  
  
        .generate-btn:active {  
            transform: translateY(0);  
        }  
  
        /* 加载动画 */  
        .loading-overlay {  
            position: fixed;  
            top: 0;  
            left: 0;  
            width: 100%;  
            height: 100%;  
            background: var(--bg-dark);  
            display: flex;  
            justify-content: center;  
            align-items: center;  
            z-index: 9999;  
            opacity: 0;  
            pointer-events: none;  
            transition: opacity 0.4s ease;  
        }  
  
        .loading-overlay.active {  
            opacity: 1;  
            pointer-events: all;  
        }  
  
        .loading-spinner {  
            width: 60px;  
            height: 60px;  
            border: 4px solid var(--glass-border);  
            border-top: 4px solid var(--primary-color);  
            border-radius: 50%;  
            animation: spin 1s linear infinite;  
            box-shadow: 0 0 20px rgba(0, 229, 255, 0.5);  
        }  
  
        /* 动画定义 */  
        @keyframes particleFloat {  
            0%, 100% { transform: translate(0, 0) rotate(0deg); }  
            33% { transform: translate(30px, -30px) rotate(120deg); }  
            66% { transform: translate(-20px, 20px) rotate(240deg); }  
        }  
  
        @keyframes rotateGeometry3D {  
            0% { transform: perspective(800px) rotateX(0deg) rotateY(0deg); }  
            25% { transform: perspective(800px) rotateX(45deg) rotateY(90deg); }  
            50% { transform: perspective(800px) rotateX(90deg) rotateY(180deg); }  
            75% { transform: perspective(800px) rotateX(135deg) rotateY(270deg); }  
            100% { transform: perspective(800px) rotateX(180deg) rotateY(360deg); }  
        }  
  
        @keyframes glowText {  
            from { text-shadow: 0 0 10px var(--accent-color); }  
            to { text-shadow: 0 0 25px var(--accent-color), 0 0 50px var(--primary-color); }  
        }  
  
        @keyframes spin {  
            0% { transform: rotate(0deg); }  
            100% { transform: rotate(360deg); }  
        }  
  
        @keyframes slideIn {  
            from { transform: translateX(100%); opacity: 0; }  
            to { transform: translateX(0); opacity: 1; }  
        }  
  
        @keyframes slideOut {  
            from { transform: translateX(0); opacity: 1; }  
            to { transform: translateX(100%); opacity: 0; }  
        }  
        
        /* 错误样式 */  
        .error-input {  
            border-color: #ff4757 !important;  
            box-shadow: 0 0 10px rgba(255, 71, 87, 0.3) !important;  
        }  
        
        .error-message {  
            color: #ff4757;  
            font-size: 12px;  
            margin-top: 5px;  
            display: none;  
        }  
        
        .required-star {  
            color: #ff4757;  
        }  
    </style>  
</head>  
<body class="subpage-bg">  
    <!-- 加载动画 -->  
    <div class="loading-overlay" id="loadingOverlay">  
        <div class="loading-spinner"></div>  
    </div>  
  
    <div class="page-header">  
        <button onclick="goHome()" class="back-btn">← 返回首页</button>  
        <h2>视频生成界面</h2>  
    </div>  
  
    <div class="video-page-container">  
        <!-- 左侧：生成结果视频 -->  
        <div class="video-display">  
            <video id="outputVideo" controls>  
                <source src="{{ url_for('static', filename='videos/sample.mp4') }}" type="video/mp4">  
                您的浏览器不支持 video 标签。  
            </video>  
            <div id="videoStatus" style="text-align: center; color: var(--accent-color); font-size: 14px; margin-top: 10px;">  
                准备生成视频  
            </div>  
        </div>  
  
        <!-- 右侧：输入框 -->  
        <div class="form-section">  
            <form id="videoForm">  
                <div class="form-group">  
                    <label>模型名称</label>  
                    <select name="model_name" id="model_name" onchange="toggleModelOptions()">  
                        <!-- 添加：TalkingGaussian 选项 -->  
                        <option value="TalkingGaussian">TalkingGaussian</option>  
                        <option value="SyncTalk">SyncTalk</option>  
                    </select>  
                </div>  
  
                <div class="form-group">  
                    <label>模型目录地址 <span class="required-star">*</span></label>  
                    <div style="display: flex; gap: 10px;">  
                        <input type="text" name="model_param" id="model_param" placeholder="请输入模型目录路径" style="flex: 1;">  
                        <button type="button" class="browse-btn" onclick="selectModelPath()" style="padding: 10px 15px; border: 1px solid var(--glass-border); border-radius: 8px; background: rgba(255,255,255,0.1); color: var(--text-primary); cursor: pointer;">浏览</button>  
                    </div>  
                    <div id="model_param_error" class="error-message">请输入模型目录地址</div>  
                    <small style="color: var(--text-secondary); font-size: 12px; margin-top: 5px; display: block;">  
                        选择训练好的模型文件夹路径，例如：output/talking_May  
                    </small>  
                </div>  
  
                <div class="form-group">  
                    <label>参考音频地址 <span class="required-star">*</span></label>  
                    <input type="text" name="ref_audio" id="ref_audio" placeholder="例如：static/uploads/audios/may_short.wav">  
                    <div id="ref_audio_error" class="error-message">请输入参考音频地址</div>  
                    <small style="color: var(--text-secondary); font-size: 12px; display: block; margin-top: 5px;">  
                        推荐：static/uploads/audios/may_short.wav（英文女声裁剪版）<br>  
                        或：static/uploads/audios/may_reference.wav（训练时自动提取）  
                    </small>  
                </div>  
  
                <div class="form-group">  
                    <label>GPU选择</label>  
                    <select name="gpu_choice">  
                        <option value="GPU0">GPU 0</option>  
                        <option value="GPU1">GPU 1</option>  
                    </select>  
                </div>  
  
                <div class="form-group">  
                    <label>目标文字（文本框）</label>  
                    <textarea name="target_text" placeholder="留空则直接使用参考音频"></textarea>  
                </div>  
  
                <!-- 添加：渲染质量等级选择 -->  
                <div class="form-group">  
                    <label>渲染质量等级</label>  
                    <select name="sh_degree" id="sh_degree">  
                        <option value="0">极速模式（最快，基础颜色）</option>  
                        <option value="1">标准模式（平衡画质与速度）</option>  
                        <option value="2" selected>高保真模式（推荐，完整光照）</option>  
                        <option value="3">最高保真模式（最慢，最佳画质）</option>  
                    </select>  
                    <small style="color: var(--text-secondary); font-size: 12px; display: block; margin-top: 5px;">  
                        调节渲染细节等级。数值越大画质越好但速度越慢。  
                    </small>  
                </div>  
  
                <button type="submit" class="generate-btn"> 生成视频</button>  
            </form>  
        </div>  
    </div>  
  
    <script>  
        // 返回首页函数  
        function goHome() {  
            // 显示加载动画  
            const loadingOverlay = document.getElementById('loadingOverlay');  
            loadingOverlay.classList.add('active');  
  
            // 清除可能的缓存问题  
            if ('serviceWorker' in navigator) {  
                navigator.serviceWorker.getRegistrations().then(function(registrations) {  
                    for(let registration of registrations) {  
                        registration.unregister();  
                    }  
                });  
            }  
  
            // 强制刷新首页  
            setTimeout(() => {  
                window.location.href = '/?t=' + new Date().getTime();  
            }, 300);  
        }  
  
        // 模型路径选择  
        function selectModelPath() {  
            // 创建文件选择器  
            const input = document.createElement('input');  
            input.type = 'file';  
            input.style.display = 'none';  
  
            // 尝试允许选择文件夹（浏览器兼容性）  
            if (typeof input.webkitdirectory !== 'undefined') {  
                input.webkitdirectory = true;  
            } else if (typeof input.directory !== 'undefined') {  
                input.directory = true;  
            }  
  
            input.onchange = function(e) {  
                if (e.target.files.length > 0) {  
                    // 获取文件路径  
                    let filePath = '';  
                    if (e.target.files[0].webkitRelativePath) {  
                        filePath = e.target.files[0].webkitRelativePath;  
                        const folderPath = filePath.substring(0, filePath.lastIndexOf('/'));  
                        document.getElementById('model_param').value = folderPath;  
                        clearInputError('model_param'); // 清除错误状态  
                    } else if (e.target.files[0].path) {  
                        filePath = e.target.files[0].path;  
                        // 处理Windows路径  
                        const folderPath = filePath.replace(/\\/g, '/');  
                        const modelPath = folderPath.substring(folderPath.lastIndexOf('/') + 1);  
                        document.getElementById('model_param').value = modelPath;  
                        clearInputError('model_param'); // 清除错误状态  
                    } else {  
                        // 获取文件名并提示用户  
                        const fileName = e.target.files[0].name;  
                        const folderName = fileName.substring(0, fileName.lastIndexOf('.'));  
                        document.getElementById('model_param').value = folderName;  
                        clearInputError('model_param'); // 清除错误状态  
                        showNotification('请确保选择的文件夹包含模型文件', 'info');  
                    }  
                }  
            };  
  
            document.body.appendChild(input);  
            input.click();  
            setTimeout(() => {  
                document.body.removeChild(input);  
            }, 100);  
        }  
  
        // 根据选择的模型显示/隐藏相关选项  
        function toggleModelOptions() {  
            const modelName = document.getElementById('model_name').value;  
            // 可以根据需要添加特定于模型的控制逻辑  
        }  
  
        // 更新视频状态显示  
        function updateVideoStatus(status, isError = false) {  
            const statusEl = document.getElementById('videoStatus');  
            if (statusEl) {  
                statusEl.textContent = status;  
                statusEl.style.color = isError ? '#ff4757' : 'var(--accent-color)';  
            }  
        }  
  
        // 重置视频显示  
        function resetVideoDisplay() {  
            const videoEl = document.getElementById('outputVideo');  
            const statusEl = document.getElementById('videoStatus');  
            
            // 重置视频源到默认  
            const defaultSrc = "{{ url_for('static', filename='videos/sample.mp4') }}";  
            videoEl.src = defaultSrc + '?t=' + new Date().getTime();  
            videoEl.load();  
            videoEl.pause(); // 暂停播放
            videoEl.currentTime = 0; // 重置到开头
            
            // 重置状态显示  
            if (statusEl) {  
                statusEl.textContent = '准备生成视频';  
                statusEl.style.color = 'var(--accent-color)';  
            }  
        }  
  
        // 显示表单错误  
        function showInputError(inputId, message) {  
            const input = document.getElementById(inputId);  
            const errorDiv = document.getElementById(inputId + '_error');  
            
            if (input && errorDiv) {  
                input.classList.add('error-input');  
                errorDiv.textContent = message;  
                errorDiv.style.display = 'block';  
            }  
        }  
  
        // 清除表单错误  
        function clearInputError(inputId) {  
            const input = document.getElementById(inputId);  
            const errorDiv = document.getElementById(inputId + '_error');  
            
            if (input && errorDiv) {  
                input.classList.remove('error-input');  
                errorDiv.style.display = 'none';  
            }  
        }  
  
        // 表单验证  
        function validateVideoForm() {  
            let isValid = true;  
            
            // 验证模型目录地址  
            const modelParamInput = document.getElementById('model_param');  
            const modelParamValue = modelParamInput.value.trim();  
            
            if (!modelParamValue) {  
                showInputError('model_param', '请输入模型目录地址');  
                isValid = false;  
            } else {  
                clearInputError('model_param');  
            }  
            
            // 验证参考音频地址  
            const refAudioInput = document.getElementById('ref_audio');  
            const refAudioValue = refAudioInput.value.trim();  
            
            if (!refAudioValue) {  
                showInputError('ref_audio', '请输入参考音频地址');  
                isValid = false;  
            } else {  
                clearInputError('ref_audio');  
            }  
            
            return isValid;  
        }  
  
            document.getElementById('videoForm').addEventListener('submit', function (e) {
        e.preventDefault();

        // 首先验证表单
        if (!validateVideoForm()) {
            showNotification('请填写所有必填字段', 'error');
            return; // 验证失败，停止提交
        }

        const formData = new FormData(this);

        // 更新状态
        updateVideoStatus('正在生成视频...');

        // 显示加载动画
        const loadingOverlay = document.getElementById('loadingOverlay');
        loadingOverlay.classList.add('active');

        fetch('/video_generation', {
            method: 'POST',
            body: formData
        })
            .then(res => {
                // 首先检查HTTP状态
                if (!res.ok) {
                    throw new Error(`HTTP错误: ${res.status}`);
                }
                return res.json();
            })
            .then(data => {
                console.log("后端返回:", data);

                // 关键修改：更严格的成功判断
                // 根据后端代码，验证失败时会返回默认路径但状态可能还是success
                // 我们需要检查返回的视频路径是否是默认的out.mp4

                const videoPath = data.video_path || '';
                const status = data.status || '';
                const message = data.message || '';

                // 情况1：明确成功且有有效视频路径
                if (status === 'success' &&
                    videoPath &&
                    !videoPath.includes('out.mp4') &&
                    !videoPath.includes('static/videos/out.mp4')) {

                    // 真正的成功：不是默认的out.mp4
                    const videoEl = document.getElementById('outputVideo');
                    const newSrc = videoPath + '?t=' + new Date().getTime();
                    videoEl.src = newSrc;
                    videoEl.load();
                    videoEl.play().catch(err => console.warn('自动播放被阻止:', err));

                    // 更新状态
                    updateVideoStatus('视频生成完成！');

                    // 创建成功提示
                    showNotification('视频生成完成！', 'success');

                }
                // 情况2：明确错误
                else if (status === 'error' || message.includes('失败') || message.includes('错误')) {

                    resetVideoDisplay();

                    // 从错误信息中提取有用的部分
                    let errorMsg = message || '未知错误';
                    if (errorMsg.includes('模型目录不存在')) {
                        errorMsg = '模型目录不存在，请检查模型路径';
                    } else if (errorMsg.includes('检查点文件不存在')) {
                        errorMsg = '模型文件不完整，请检查模型目录';
                    } else if (errorMsg.includes('格式错误')) {
                        errorMsg = '路径格式错误，请使用正确的路径格式';
                    }

                    updateVideoStatus('生成失败: ' + errorMsg, true);
                    showNotification('视频生成失败！' + errorMsg, 'error');

                }
                // 情况3：返回了默认的out.mp4路径（后端验证失败但返回了默认视频）
                else if (videoPath.includes('out.mp4') || videoPath.includes('static/videos/out.mp4')) {

                    resetVideoDisplay();

                    // 检查是否有错误消息
                    if (message) {
                        let errorMsg = message;
                        if (errorMsg.includes('模型目录不存在')) {
                            errorMsg = '模型目录不存在，请检查模型路径';
                        }
                        updateVideoStatus('生成失败: ' + errorMsg, true);
                        showNotification('视频生成失败！' + errorMsg, 'error');
                    } else {
                        // 没有错误消息但返回了默认视频，可能是验证失败
                        updateVideoStatus('生成失败：请检查模型和音频路径', true);
                        showNotification('视频生成失败：请检查模型和音频路径是否正确', 'error');
                    }

                }
                // 情况4：其他情况（可能是后端bug）
                else {

                    resetVideoDisplay();

                    if (videoPath) {
                        // 有视频路径但不是默认的，尝试播放但显示警告
                        const videoEl = document.getElementById('outputVideo');
                        const newSrc = videoPath + '?t=' + new Date().getTime();
                        videoEl.src = newSrc;
                        videoEl.load();
                        videoEl.play().catch(err => console.warn('自动播放被阻止:', err));

                        updateVideoStatus('视频已生成（状态未知）');
                        showNotification('视频已生成，但服务器返回状态异常', 'warning');
                    } else {
                        // 没有视频路径
                        updateVideoStatus('生成失败：服务器未返回视频路径', true);
                        showNotification('生成失败：服务器未返回视频路径', 'error');
                    }
                }
            })
            .catch(err => {
                console.error('请求错误:', err);

                // 网络错误，重置视频显示
                resetVideoDisplay();

                // 更新状态
                updateVideoStatus('网络错误，请重试', true);

                // 显示错误通知
                showNotification('生成失败，请重试', 'error');
            })
            .finally(() => {
                // 隐藏加载动画
                setTimeout(() => {
                    loadingOverlay.classList.remove('active');
                }, 500);
            });
    });
  
        // 通知提示函数  
        function showNotification(message, type) {  
            const notification = document.createElement('div');  
            notification.style.cssText = `  
                position: fixed;  
                top: 20px;  
                right: 20px;  
                padding: 15px 25px;  
                background: ${type === 'success' ? 'linear-gradient(135deg, #00c6ff, #0072ff)' : 'linear-gradient(135deg, #ff4757, #ff6348)'};  
                color: white;  
                border-radius: 10px;  
                box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);  
                z-index: 10000;  
                animation: slideIn 0.3s ease;  
                font-weight: bold;  
            `;  
            notification.textContent = message;  
  
            document.body.appendChild(notification);  
  
            setTimeout(() => {  
                notification.style.animation = 'slideOut 0.3s ease';  
                setTimeout(() => notification.remove(), 300);  
            }, 3000);  
        }  
  
        // 页面加载完成后隐藏加载动画  
        document.addEventListener('DOMContentLoaded', function() {  
            const body = document.body;  
            // 恢复主题设置  
            const savedTheme = localStorage.getItem('theme');  
            if (savedTheme === 'light') {  
                body.classList.add('light-theme');  
            }  
            
            // 监听输入框变化，清除错误状态  
            const modelParamInput = document.getElementById('model_param');  
            if (modelParamInput) {  
                modelParamInput.addEventListener('input', function() {  
                    if (this.value.trim()) {  
                        clearInputError('model_param');  
                    }  
                });  
            }  
            
            const refAudioInput = document.getElementById('ref_audio');  
            if (refAudioInput) {  
                refAudioInput.addEventListener('input', function() {  
                    if (this.value.trim()) {  
                        clearInputError('ref_audio');  
                    }  
                });  
            }  
  
            // 恢复全屏状态  
            const wasFullscreen = localStorage.getItem('isFullscreen') === 'true';  
            if (wasFullscreen && !document.fullscreenElement) {  
                // 如果之前是全屏状态，自动进入全屏  
                document.documentElement.requestFullscreen().catch(e => {  
                    console.log('自动全屏失败:', e);  
                const restoreFullscreen = () => {  
                document.documentElement.requestFullscreen().catch(e => console.error(e));  
                // 移除监听器，确保只触发一次  
                document.removeEventListener('click', restoreFullscreen);  
                document.removeEventListener('touchstart', restoreFullscreen);  
            };  
  
            // 监听点击和触摸（适配移动端）  
            document.addEventListener('click', restoreFullscreen, { once: true });  
            document.addEventListener('touchstart', restoreFullscreen, { once: true });  
  
  
           showNotification('点击任意位置恢复全屏', 'info');  
        });  
    }  
  
            // 监听全屏状态变化  
            document.addEventListener('fullscreenchange', function() {  
                const isFullscreen = !!document.fullscreenElement;  
                localStorage.setItem('isFullscreen', isFullscreen.toString());  
            });  
  
        });  
    </script>  
</body>  
</html>