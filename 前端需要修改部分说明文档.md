# 前端修改说明文档

## 一、概述

本文档说明前端需要修改的部分以及后端接口的详细说明。

---

## 二、通用修改（所有页面）

### 2.1 模型名称选项

**修改位置**：所有页面的模型选择下拉菜单

**要求**：
- 在所有模型选择下拉菜单中添加 `TalkingGaussian` 选项
- 选项值：`TalkingGaussian`
- 显示文本：`TalkingGaussian`

**示例代码**：
```html
<select name="model_name" id="model_name">
    <option value="TalkingGaussian">TalkingGaussian</option>
    <option value="SyncTalk">SyncTalk</option>
    <!-- 其他模型选项 -->
</select>
```

**影响的页面**：
- ✅ 视频生成页面 (`/video_generation`)
- ✅ 实时对话页面 (`/chat_system`)
- ✅ 模型训练页面 (`/model_training`)

---

### 2.2 界面尺寸统一

**修改位置**：所有页面的视频显示区域

**要求**：
- 视频显示框大小保持一致
- 建议尺寸：宽度 640px，高度 480px（或根据设计稿调整）
- 所有页面的视频容器使用相同的 CSS 类或样式

**示例代码**：
```css
.video-container {
    width: 640px;
    height: 480px;
    border: 1px solid #ddd;
    border-radius: 8px;
    overflow: hidden;
    background: #000;
}

.video-container video {
    width: 100%;
    height: 100%;
    object-fit: contain;
}
```

---

## 三、视频生成页面 (`/video_generation`)

### 3.1 模型地址选择 - 文件选择器

**修改位置**：模型参数输入框

**当前状态**：文本输入框

**修改要求**：
- 将模型参数输入框改为**文件选择器**（`<input type="file">`）
- 或者添加一个"浏览"按钮，点击后弹出文件/文件夹选择对话框
- 选择后自动填充到输入框

**实现方案一（推荐）**：文件选择器
```html
<div class="form-group">
    <label>模型路径</label>
    <div style="display: flex; gap: 10px;">
        <input type="text" 
               name="model_param" 
               id="model_param" 
               placeholder="选择或输入模型路径"
               readonly>
        <button type="button" onclick="selectModelPath()">浏览</button>
    </div>
    <small style="color: #888; font-size: 12px;">
        选择训练好的模型文件夹路径
    </small>
</div>

<script>
function selectModelPath() {
    // 注意：浏览器无法直接选择文件夹，需要后端支持
    // 方案：使用文件选择器选择模型文件夹中的任意文件，然后提取文件夹路径
    const input = document.createElement('input');
    input.type = 'file';
    input.webkitdirectory = true;  // 允许选择文件夹（Chrome/Edge）
    input.directory = true;  // Firefox
    input.onchange = function(e) {
        if (e.target.files.length > 0) {
            const filePath = e.target.files[0].webkitRelativePath || e.target.files[0].path;
            const folderPath = filePath.substring(0, filePath.lastIndexOf('/'));
            document.getElementById('model_param').value = folderPath;
        }
    };
    input.click();
}
</script>
```

**实现方案二**：文本输入 + 后端接口
- 保持文本输入框
- 添加"浏览"按钮，点击后调用后端接口获取可用模型列表
- 显示模型列表供用户选择

**后端接口**：
```javascript
// GET /api/models/list
// 返回：{ "models": ["output/talking_May", "output/talking_John", ...] }
```

---

### 3.2 渲染质量等级选择

**修改位置**：视频生成表单

**要求**：添加渲染质量等级选择器

**UI 实现**：
```html
<div class="form-group">
    <label>渲染质量等级</label>
    <select name="sh_degree" id="sh_degree">
        <option value="0">极速模式（最快，基础颜色）</option>
        <option value="1">标准模式（平衡画质与速度）</option>
        <option value="2" selected>高保真模式（推荐，完整光照）</option>
        <option value="3">最高保真模式（最慢，最佳画质）</option>
    </select>
    <small style="color: #888; font-size: 12px;">
        调节渲染细节等级。数值越大画质越好但速度越慢。
    </small>
</div>
```

**参数说明**：
- `sh_degree`: 渲染细节等级
  - `0`: 极速模式
  - `1`: 标准模式
  - `2`: 高保真模式（默认）
  - `3`: 最高保真模式

---

### 3.3 接口说明

**接口地址**：`POST /video_generation`

**请求参数**：
```javascript
{
    model_name: "TalkingGaussian",      // 必填，模型名称
    model_param: "output/talking_May",  // 必填，模型路径（相对路径）
    ref_audio: "static/audios/test.wav", // 必填，参考音频路径
    gpu_choice: "GPU0",                  // 可选，GPU选择
    target_text: "",                     // 可选，目标文本（暂未使用）
    sh_degree: "2"                       // 可选，渲染质量等级（0-3），默认 2
}
```

**响应格式**：
```javascript
{
    status: "success",
    video_path: "/static/videos/talkinggaussian_test.mp4"
}
```

**错误响应**：
```javascript
{
    status: "error",
    message: "错误信息"
}
```

---

## 四、实时对话页面 (`/chat_system`)

### 4.1 语音克隆参考音频选择

**修改位置**：实时对话表单

**要求**：实现三种参考音频选择方式

**UI 实现**：
```html
<div class="form-group">
    <label>语音克隆参考音频</label>
    <div>
        <label>
            <input type="radio" name="voice_clone_type" value="current_recording" checked>
            <span>当前录音</span>
        </label>
        <label>
            <input type="radio" name="voice_clone_type" value="preset_voice">
            <span>预设音色</span>
        </label>
        <label>
            <input type="radio" name="voice_clone_type" value="custom">
            <span>自定义上传</span>
        </label>
    </div>
    
    <!-- 预设音色选择（当选择预设音色时显示） -->
    <div id="preset_voice_group" style="display: none; margin-top: 10px;">
        <label>预设音色</label>
        <select name="preset_voice_name" id="preset_voice_name">
            <option value="default">默认音色</option>
            <option value="cross_lingual">跨语言音色</option>
        </select>
    </div>
    
    <!-- 自定义上传（当选择自定义时显示） -->
    <div id="custom_voice_group" style="display: none; margin-top: 10px;">
        <label>上传音频文件</label>
        <input type="file" 
               name="custom_voice_file" 
               id="custom_voice_file"
               accept=".wav,.mp3,.m4a,.flac">
        <small style="color: #888; font-size: 12px;">
            支持 .wav, .mp3, .m4a, .flac 格式
        </small>
    </div>
</div>

<script>
// 根据选择的类型显示/隐藏相应的输入框
document.querySelectorAll('input[name="voice_clone_type"]').forEach(radio => {
    radio.addEventListener('change', function() {
        const presetGroup = document.getElementById('preset_voice_group');
        const customGroup = document.getElementById('custom_voice_group');
        
        if (this.value === 'preset_voice') {
            presetGroup.style.display = 'block';
            customGroup.style.display = 'none';
        } else if (this.value === 'custom') {
            presetGroup.style.display = 'none';
            customGroup.style.display = 'block';
        } else {
            presetGroup.style.display = 'none';
            customGroup.style.display = 'none';
        }
    });
});

// 处理自定义音频文件上传
document.getElementById('custom_voice_file').addEventListener('change', function(e) {
    if (e.target.files.length > 0) {
        const file = e.target.files[0];
        const formData = new FormData();
        formData.append('audio', file);
        
        fetch('/upload_voice_clone', {
            method: 'POST',
            body: formData
        })
        .then(res => res.json())
        .then(data => {
            if (data.status === 'success') {
                // 保存文件名，用于后续提交
                document.getElementById('custom_voice_file').setAttribute('data-filename', data.filename);
                alert('音频上传成功');
            } else {
                alert('上传失败：' + data.message);
            }
        })
        .catch(err => {
            console.error('上传错误:', err);
            alert('上传失败，请重试');
        });
    }
});
</script>
```

**提交表单时的处理**：
```javascript
// 在提交表单时，需要根据 voice_clone_type 的值处理
const formData = new FormData(form);
const voiceCloneType = formData.get('voice_clone_type');

if (voiceCloneType === 'custom') {
    // 获取上传后的文件名
    const filename = document.getElementById('custom_voice_file').getAttribute('data-filename');
    if (filename) {
        formData.set('custom_voice_file', filename);
    }
}
```

---

### 4.2 语音克隆参数选择

#### 4.2.1 语言类型选择

**UI 实现**：
```html
<div class="form-group">
    <label>语音合成语言</label>
    <select name="language" id="language">
        <option value="zh" selected>中文</option>
        <option value="en">English</option>
    </select>
    <small style="color: #888; font-size: 12px;">
        选择 AI 回复的语音合成语言类型
    </small>
</div>
```

#### 4.2.2 语速调节（滑块）

**UI 实现**：
```html
<div class="form-group">
    <label>语速调节</label>
    <input type="range" 
           name="speed" 
           id="speed"
           min="0.5" 
           max="2.0" 
           step="0.1" 
           value="1.0"
           oninput="updateSpeedValue(this.value)">
    <div style="display: flex; justify-content: space-between; font-size: 12px; color: #888; margin-top: 5px;">
        <span>0.5 (慢速)</span>
        <span id="speedValue">1.0 (正常)</span>
        <span>2.0 (快速)</span>
    </div>
    <small style="color: #888; font-size: 12px;">
        调节数字人的说话节奏。数值越小语速越慢（沉稳），数值越大语速越快（活泼）。
    </small>
</div>

<script>
function updateSpeedValue(value) {
    const speedText = value < 1.0 ? '慢速' : value > 1.0 ? '快速' : '正常';
    document.getElementById('speedValue').textContent = parseFloat(value).toFixed(1) + ' (' + speedText + ')';
}
</script>
```

---

### 4.3 渲染质量等级选择

**UI 实现**（同视频生成页面）：
```html
<div class="form-group">
    <label>渲染质量等级</label>
    <select name="sh_degree" id="sh_degree">
        <option value="0">极速模式（最快，基础颜色）</option>
        <option value="1">标准模式（平衡画质与速度）</option>
        <option value="2" selected>高保真模式（推荐，完整光照）</option>
        <option value="3">最高保真模式（最慢，最佳画质）</option>
    </select>
    <small style="color: #888; font-size: 12px;">
        调节渲染细节等级。数值越大画质越好但速度越慢。
    </small>
</div>
```

---

### 4.4 接口说明

**接口地址**：`POST /chat_system`

**请求参数**：
```javascript
{
    model_name: "TalkingGaussian",           // 必填，模型名称
    model_param: "output/talking_May",      // 必填，模型路径
    voice_clone_type: "preset_voice",       // 必填，参考音频类型：current_recording / preset_voice / custom
    preset_voice_name: "default",           // 可选，预设音色名称（当 voice_clone_type 为 preset_voice 时）
    custom_voice_file: "custom_voice_xxx.wav", // 可选，自定义音频文件名（当 voice_clone_type 为 custom 时）
    language: "zh",                          // 可选，语言类型（zh/en），默认 zh
    speed: "1.0",                            // 可选，语速（0.5-2.0），默认 1.0
    sh_degree: "2",                          // 可选，渲染质量等级（0-3），默认 2
    api_choice: "zhipu"                     // 可选，API选择
}
```

**响应格式**：
```javascript
{
    status: "success",
    video_path: "/static/videos/chat_response.mp4"
}
```

**上传自定义音频接口**：`POST /upload_voice_clone`

**请求参数**：
```javascript
FormData {
    audio: File  // 音频文件
}
```

**响应格式**：
```javascript
{
    status: "success",
    message: "音频上传成功",
    filename: "custom_voice_1234567890.wav",
    filepath: "./static/audios/custom_voice/custom_voice_1234567890.wav"
}
```

---

## 五、模型训练页面 (`/model_training`)

### 5.1 EPOCH 参数动态显示

**修改位置**：训练参数区域

**要求**：
- `epoch` 参数输入框**仅在选择 SyncTalk 模型时显示**
- 选择 TalkingGaussian 时隐藏 `epoch` 输入框
- 添加说明文字

**UI 实现**：
```html
<div class="form-group">
    <label>模型选择</label>
    <select name="model_choice" id="model_choice" onchange="toggleEpochField()">
        <option value="TalkingGaussian">TalkingGaussian</option>
        <option value="SyncTalk">SyncTalk</option>
    </select>
</div>

<div class="form-group" id="epoch_group" style="display: none;">
    <label>训练轮数 (EPOCH)</label>
    <input type="number" 
           name="epoch" 
           id="epoch"
           min="1" 
           value="100"
           placeholder="输入训练轮数">
    <small style="color: #888; font-size: 12px;">
        此参数仅对 SyncTalk 模型有效。TalkingGaussian 使用固定训练策略。
    </small>
</div>

<script>
function toggleEpochField() {
    const modelChoice = document.getElementById('model_choice').value;
    const epochGroup = document.getElementById('epoch_group');
    
    if (modelChoice === 'SyncTalk') {
        epochGroup.style.display = 'block';
    } else {
        epochGroup.style.display = 'none';
    }
}

// 页面加载时执行一次
toggleEpochField();
</script>
```

---

### 5.2 训练完成后模型地址输出

**修改位置**：训练结果展示区域

**要求**：
- 训练完成后，显示生成的模型路径
- 模型路径可以复制
- 模型路径格式：`output/talking_May`（相对路径）

**UI 实现**：
```html
<div id="training_result" style="display: none; margin-top: 20px; padding: 15px; background: #f5f5f5; border-radius: 8px;">
    <h3>训练完成</h3>
    <div class="form-group">
        <label>模型路径：</label>
        <div style="display: flex; gap: 10px; align-items: center;">
            <input type="text" 
                   id="model_path_output" 
                   readonly 
                   style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            <button type="button" onclick="copyModelPath()">复制</button>
        </div>
        <small style="color: #888; font-size: 12px;">
            此路径可用于视频生成和实时对话中的"模型参数"字段
        </small>
    </div>
</div>

<script>
function copyModelPath() {
    const modelPathInput = document.getElementById('model_path_output');
    modelPathInput.select();
    document.execCommand('copy');
    alert('模型路径已复制到剪贴板');
}

// 在训练完成的回调中显示模型路径
function handleTrainingComplete(response) {
    if (response.status === 'success') {
        const modelPath = response.model_path;
        document.getElementById('model_path_output').value = modelPath;
        document.getElementById('training_result').style.display = 'block';
    }
}
</script>
```

**注意**：当前后端返回的是 `video_path`，但训练接口应该返回 `model_path`。需要后端修改或前端适配。

---

### 5.3 接口说明

**接口地址**：`POST /model_training`

**请求参数**：
```javascript
{
    model_choice: "TalkingGaussian",     // 必填，模型选择
    ref_video: "TalkingGaussian/data/May/May.mp4", // 必填，参考视频路径
    gpu_choice: "GPU0",                  // 可选，GPU选择
    epoch: "100",                        // 可选，训练轮数（仅 SyncTalk 有效）
    custom_params: ""                    // 可选，自定义参数
}
```

**响应格式**：
```javascript
{
    status: "success",
    model_path: "output/talking_May",  // 模型路径（相对路径）
    message: "训练完成，模型路径：output/talking_May"
}
```

---

## 六、参数说明汇总

### 6.1 语音克隆参数

| 参数名 | 类型 | 必填 | 默认值 | 说明 |
|--------|------|------|--------|------|
| `voice_clone_type` | string | 是 | - | 参考音频类型：`current_recording` / `preset_voice` / `custom` |
| `preset_voice_name` | string | 否 | - | 预设音色名称（当 `voice_clone_type` 为 `preset_voice` 时） |
| `custom_voice_file` | string | 否 | - | 自定义音频文件名（当 `voice_clone_type` 为 `custom` 时） |
| `language` | string | 否 | `zh` | 语言类型：`zh`（中文）或 `en`（英文） |
| `speed` | float | 否 | `1.0` | 语速调节（0.5-2.0），1.0 为正常速度 |

### 6.2 渲染质量参数

| 参数名 | 类型 | 必填 | 默认值 | 说明 |
|--------|------|------|--------|------|
| `sh_degree` | int | 否 | `2` | 渲染细节等级：0（极速）、1（标准）、2（高保真）、3（最高保真） |

### 6.3 训练参数

| 参数名 | 类型 | 必填 | 默认值 | 说明 |
|--------|------|------|--------|------|
| `epoch` | int | 否 | - | 训练轮数（**仅 SyncTalk 有效**，TalkingGaussian 不使用此参数） |

---

## 七、前端修改清单

### 需要修改

1. **所有页面**：
   - [ ] 添加 TalkingGaussian 模型选项
   - [ ] 统一视频显示框尺寸

2. **视频生成页面**：
   - [ ] 模型路径选择改为文件选择器（或添加浏览按钮）
   - [ ] 添加渲染质量等级选择器

3. **实时对话页面**：
   - [ ] 实现语音克隆参考音频三种选择方式（当前录音/预设音色/自定义）
   - [ ] 添加语言类型选择器
   - [ ] 添加语速调节滑块
   - [ ] 添加渲染质量等级选择器
   - [ ] 实现自定义音频文件上传功能

4. **模型训练页面**：
   - [ ] EPOCH 参数仅在 SyncTalk 时显示
   - [ ] 训练完成后显示模型路径并支持复制
---

## 八、测试建议

### 8.1 功能测试

1. **模型选择**：
   - 测试所有页面的 TalkingGaussian 选项是否正常显示
   - 测试选择 TalkingGaussian 后功能是否正常

2. **视频生成**：
   - 测试模型路径选择功能
   - 测试渲染质量等级选择（0, 1, 2, 3）

3. **实时对话**：
   - 测试三种参考音频选择方式
   - 测试语言类型切换（中文/英文）
   - 测试语速调节滑块（0.5-2.0）
   - 测试自定义音频上传功能

4. **模型训练**：
   - 测试 EPOCH 字段的显示/隐藏逻辑
   - 测试训练完成后模型路径显示

### 8.2 兼容性测试

- 测试不传新参数时，后端是否使用默认值
- 测试旧版本前端代码是否仍能正常工作

---

## 九、常见问题

### Q1: 模型路径选择如何实现？

**A**: 浏览器无法直接选择文件夹，有两种方案：
1. 使用 `<input type="file" webkitdirectory>` 选择文件夹（Chrome/Edge 支持）
2. 保持文本输入框，添加"浏览"按钮，调用后端接口获取可用模型列表

### Q2: 自定义音频上传后如何使用？

**A**: 
1. 用户选择"自定义上传"
2. 选择音频文件后，调用 `/upload_voice_clone` 接口上传
3. 上传成功后，保存返回的 `filename`
4. 提交表单时，将 `filename` 作为 `custom_voice_file` 参数传递

### Q3: EPOCH 参数为什么只在 SyncTalk 时显示？

**A**: TalkingGaussian 使用固定的训练策略（硬编码的迭代次数），EPOCH 参数对其无效。

---


