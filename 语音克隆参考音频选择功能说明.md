# 语音克隆参考音频选择功能说明

## 一、功能概述

本次修改实现了语音克隆参考音频的三种选择方式：
1. **当前录音**：使用用户刚录制的音频作为参考
2. **预设音色**：使用系统预设的音频文件作为参考
3. **自定义**：用户上传自定义音频文件作为参考

## 二、修改的文件

### 1. `app.py`
**新增接口**：
- `/upload_voice_clone` (POST): 上传自定义语音克隆参考音频文件

**修改接口**：
- `/chat_system` (POST): 新增参数支持新的三种选择方式

### 2. `backend/chat_engine.py`
**新增内容**：
- `PRESET_VOICES` 字典：预设音色配置
- `get_voice_clone_reference()` 函数：根据选择类型返回参考音频路径

**修改内容**：
- `chat_response()` 函数：使用新的参考音频选择逻辑

## 三、预设音频文件位置

### 预设音色文件位置
- **默认音色**：`./CosyVoice/asset/zero_shot_prompt.wav`
- **跨语言音色**：`./CosyVoice/asset/cross_lingual_prompt.wav`
- 可以在 `PRESET_VOICES` 字典中添加更多预设音色

### 当前录音位置
- `./static/audios/input.wav`（用户录音保存位置）

### 自定义音频位置
- `./static/audios/custom_voice/` 目录
- 上传的文件会自动生成唯一文件名：`custom_voice_{timestamp}.{ext}`

## 四、API 接口说明

### 1. 上传自定义音频接口

**接口路径**：`POST /upload_voice_clone`

**请求格式**：
```
Content-Type: multipart/form-data
Form Data:
  - audio: 音频文件（.wav, .mp3, .m4a, .flac）
```

**响应格式**：
```json
{
  "status": "success",
  "message": "音频上传成功",
  "filename": "custom_voice_1234567890.wav",
  "filepath": "./static/audios/custom_voice/custom_voice_1234567890.wav"
}
```

**错误响应**：
```json
{
  "status": "error",
  "message": "错误信息"
}
```

### 2. 对话系统接口（修改后）

**接口路径**：`POST /chat_system`

**请求参数**（新格式）：
```
Form Data:
  - model_name: 模型名称
  - model_param: 模型路径
  - voice_clone_type: 选择类型
    - "current_recording": 使用当前录音
    - "preset_voice": 使用预设音色
    - "custom": 使用自定义音频
  - preset_voice_name: 预设音色名称（当 voice_clone_type="preset_voice" 时使用）
    - "default": 默认音色
    - "cross_lingual": 跨语言音色
  - custom_voice_file: 自定义音频文件名（当 voice_clone_type="custom" 时使用）
    - 例如: "custom_voice_1234567890.wav"
  - api_choice: 对话API选择
```

**兼容性**：
- 保留旧参数 `voice_clone` 以兼容旧版本前端
- 如果提供了 `voice_clone` 参数，会优先使用该参数

## 五、使用示例

### 示例1：使用当前录音
```python
data = {
    "voice_clone_type": "current_recording",
    # 其他参数...
}
```

### 示例2：使用预设音色
```python
data = {
    "voice_clone_type": "preset_voice",
    "preset_voice_name": "default",  # 或 "cross_lingual"
    # 其他参数...
}
```

### 示例3：使用自定义音频
```python
# 步骤1：先上传音频文件
# POST /upload_voice_clone
# 返回: {"filename": "custom_voice_1234567890.wav", ...}

# 步骤2：使用上传的文件
data = {
    "voice_clone_type": "custom",
    "custom_voice_file": "custom_voice_1234567890.wav",
    # 其他参数...
}
```

## 六、前端集成说明

### 需要前端配合的部分

1. **语音克隆选择UI**：
   - 添加选择器（单选按钮或下拉菜单）：
     - 当前录音
     - 预设音色（需要显示可选的预设音色列表）
     - 自定义（需要文件上传组件）

2. **预设音色列表**：
   - 可以从后端获取预设音色列表（当前硬编码在 `PRESET_VOICES` 字典中）
   - 或者前端直接使用已知的预设音色名称：`"default"`, `"cross_lingual"`

3. **文件上传**：
   - 当选择"自定义"时，显示文件上传组件
   - 上传到 `/upload_voice_clone` 接口
   - 获取返回的 `filename`，在提交对话时使用

4. **表单提交**：
   - 根据用户选择，设置 `voice_clone_type` 参数
   - 如果选择预设音色，设置 `preset_voice_name`
   - 如果选择自定义，设置 `custom_voice_file`（使用上传接口返回的 `filename`）

### 前端代码示例（伪代码）

```javascript
// 上传自定义音频
async function uploadCustomVoice(file) {
    const formData = new FormData();
    formData.append('audio', file);
    
    const response = await fetch('/upload_voice_clone', {
        method: 'POST',
        body: formData
    });
    
    const result = await response.json();
    if (result.status === 'success') {
        return result.filename;  // 保存这个文件名
    }
}

// 提交对话
async function submitChat() {
    const formData = new FormData();
    
    // 根据用户选择设置参数
    if (voiceCloneType === 'current_recording') {
        formData.append('voice_clone_type', 'current_recording');
    } else if (voiceCloneType === 'preset_voice') {
        formData.append('voice_clone_type', 'preset_voice');
        formData.append('preset_voice_name', selectedPresetVoice);
    } else if (voiceCloneType === 'custom') {
        formData.append('voice_clone_type', 'custom');
        formData.append('custom_voice_file', uploadedFileName);
    }
    
    // 其他参数...
    const response = await fetch('/chat_system', {
        method: 'POST',
        body: formData
    });
}
```

## 七、添加新的预设音色

如果需要添加新的预设音色，只需在 `backend/chat_engine.py` 中的 `PRESET_VOICES` 字典中添加：

```python
PRESET_VOICES = {
    "default": "./CosyVoice/asset/zero_shot_prompt.wav",
    "cross_lingual": "./CosyVoice/asset/cross_lingual_prompt.wav",
    "voice1": "./CosyVoice/asset/voice1.wav",  # 新增
    "voice2": "./CosyVoice/asset/voice2.wav",  # 新增
}
```

然后将对应的音频文件放到 `./CosyVoice/asset/` 目录下即可。

## 八、错误处理

- 如果选择的参考音频文件不存在，系统会自动回退到默认预设音色
- 所有错误都会在控制台输出日志，便于调试
- 如果所有参考音频都不存在，会返回错误并终止流程

## 九、注意事项

1. **文件格式**：自定义音频支持 `.wav`, `.mp3`, `.m4a`, `.flac` 格式
2. **文件大小**：建议前端限制上传文件大小（建议不超过 10MB）
3. **音频质量**：参考音频的质量会影响语音克隆效果，建议使用清晰、无噪音的音频
4. **兼容性**：保留了旧版本的 `voice_clone` 参数，确保向后兼容

## 十、测试建议

1. 测试三种选择方式是否都能正常工作
2. 测试文件上传功能
3. 测试预设音色切换
4. 测试错误处理（文件不存在、格式错误等）
5. 测试向后兼容性（使用旧参数格式）

