# 项目运行与环境说明文档

## 一、环境配置现状

### 1.1 已存在的Conda环境

根据您提供的 `conda env list` 输出，系统中已存在以下环境：

| 环境名称 | 用途 | Python版本 | 主要依赖 |
|---------|------|-----------|---------|
| `base` | 基础环境 | - | - |
| `cosyvoice` | CosyVoice项目 | - | PyTorch 2.3.1, transformers等 |
| `talking_gaussian` | TalkingGaussian项目 | 3.7.13 | PyTorch 1.12.1, CUDA 11.3 |
| `tg_eval` | TalkingGaussian评估 | - | - |
| `tg_niqe` | TalkingGaussian NIQE评估 | - | - |

### 1.2 环境依赖差异

**TalkingGaussian环境** (`talking_gaussian`):
- Python 3.7.13
- PyTorch 1.12.1
- CUDA 11.3
- 需要编译的扩展：diff-gaussian-rasterization, simple-knn, gridencoder

**CosyVoice环境** (`cosyvoice`):
- Python 3.10（推测）
- PyTorch 2.3.1
- CUDA 12.1
- 需要：transformers, modelscope, onnxruntime-gpu等

**关键问题**：两个环境的PyTorch版本不兼容（1.12.1 vs 2.3.1），无法在同一个环境中运行。

---

## 二、当前调用流程分析

### 2.1 Flask应用运行环境

**当前状态**：`app.py` 在 `base` 环境中运行（或任意环境）

**原因**：
- Flask应用本身只负责路由和参数传递
- 不直接调用TalkingGaussian或CosyVoice的Python代码
- 通过 `subprocess.run()` 调用外部脚本

### 2.2 当前调用方式（问题）

**问题1：没有环境切换机制**

查看当前代码：

```python
# backend/video_generator.py (第121行)
cmd = ['bash', 'TalkingGaussian/run_talkinggaussian.sh', 'infer', ...]
subprocess.run(cmd, ...)  # ❌ 没有指定conda环境

# backend/chat_engine.py (第325行)
cmd = ['python', cosyvoice_script, ...]
subprocess.run(cmd, ...)  # ❌ 没有指定conda环境

# backend/model_trainer.py (第70行)
cmd = ['bash', 'TalkingGaussian/scripts/train_xx.sh', ...]
subprocess.run(cmd, ...)  # ❌ 没有指定conda环境
```

**当前问题**：
- 所有脚本都在**当前激活的conda环境**中运行
- 如果Flask在 `base` 环境运行，调用TalkingGaussian脚本会失败（缺少依赖）
- 如果Flask在 `talking_gaussian` 环境运行，调用CosyVoice脚本会失败（PyTorch版本不兼容）

---

## 三、正确的调用流程设计

### 3.1 应该使用的调用方式

#### 方案一：使用 `conda run`（推荐）

```python
# 调用TalkingGaussian（需要talking_gaussian环境）
cmd = [
    'conda', 'run', '-n', 'talking_gaussian', '--no-capture-output',
    'python', 'TalkingGaussian/test_talkinggaussian.py',
    ...
]

# 调用CosyVoice（需要cosyvoice环境）
cmd = [
    'conda', 'run', '-n', 'cosyvoice', '--no-capture-output',
    'python', 'CosyVoice/test_cosyvoice.py',
    ...
]
```

**优点**：
- 自动切换到指定环境
- 不改变当前激活的环境
- `--no-capture-output` 确保输出实时显示

#### 方案二：在脚本中激活环境

修改 `run_talkinggaussian.sh` 和 `test_cosyvoice.py`，在脚本开头激活对应环境：

```bash
#!/usr/bin/env bash
# run_talkinggaussian.sh
source $(conda info --base)/etc/profile.d/conda.sh
conda activate talking_gaussian
# ... 后续命令
```

**缺点**：
- 需要修改所有脚本
- 可能影响其他调用方式

---

## 四、完整调用流程

### 4.1 原先的流程（独立使用）

#### TalkingGaussian训练流程
```
1. 激活环境：conda activate talking_gaussian
2. 数据预处理：python data_utils/process.py ...
3. 模型训练：bash scripts/train_xx.sh ...
4. 推理：python test_talkinggaussian.py ...
```

#### CosyVoice推理流程
```
1. 激活环境：conda activate cosyvoice
2. 语音克隆：python test_cosyvoice.py ...
```

### 4.2 现在的流程（整合后，已实现环境切换）

#### 视频生成页面流程
```
用户提交表单
  ↓
Flask (base环境) 接收请求
  ↓
backend/video_generator.py
  ↓
调用: bash TalkingGaussian/run_talkinggaussian.sh
  ↓
Shell脚本内部: conda run -n talking_gaussian ✅
  ↓
执行: python test_talkinggaussian.py (在talking_gaussian环境中)
  ↓
返回视频路径
```

#### 模型训练页面流程
```
用户提交表单
  ↓
Flask (base环境) 接收请求
  ↓
backend/model_trainer.py
  ↓
数据预处理: conda run -n talking_gaussian ✅
  ↓
调用: bash TalkingGaussian/scripts/train_xx.sh
  ↓
Shell脚本内部: conda run -n talking_gaussian ✅
  ↓
执行训练脚本 (在talking_gaussian环境中)
  ↓
返回模型路径
```

#### 实时对话页面流程
```
用户提交表单
  ↓
Flask (base环境) 接收请求
  ↓
backend/chat_engine.py
  ↓
步骤1: ASR (使用当前环境的speech_recognition)
  ↓
步骤2: LLM (使用当前环境的zhipuai)
  ↓
步骤3: CosyVoice语音克隆
  ├─ 调用: bash CosyVoice/run_cosyvoice.sh
  └─ Shell脚本内部: conda run -n cosyvoice ✅
  ↓
步骤4: TalkingGaussian视频生成
  ├─ 调用: bash TalkingGaussian/run_talkinggaussian.sh
  └─ Shell脚本内部: conda run -n talking_gaussian ✅
  ↓
返回视频路径
```

---

## 五、环境切换机制（推荐方案：Shell脚本中使用conda run）✅ 已实现

### 5.1 方案选择

**推荐方案**：在Shell脚本中使用 `conda run`，Python代码保持简洁

**优点**：
- ✅ Python代码简洁，不涉及环境管理
- ✅ 环境切换逻辑集中在Shell脚本中
- ✅ 使用 `conda run` 更可靠（官方推荐）
- ✅ 不需要source conda.sh，更简单
- ✅ 符合"关注点分离"原则

### 5.2 实现方案

#### 方案架构

```
Flask (base环境)
  ↓
Python代码：只调用Shell脚本
  ↓
Shell脚本：使用conda run切换环境
  ↓
执行Python脚本（在指定环境中）
```

### 5.3 已完成的修改 ✅

#### 1. TalkingGaussian/run_talkinggaussian.sh ✅
- ✅ 在python命令前添加 `conda run -n talking_gaussian --no-capture-output`
- ✅ 保持现有逻辑不变

**修改示例**：
```bash
# 修改前
python test_talkinggaussian.py --audio_file "$WAV" ...

# 修改后
conda run -n talking_gaussian --no-capture-output \
    python test_talkinggaussian.py --audio_file "$WAV" ...
```

#### 2. TalkingGaussian/scripts/train_xx.sh ✅
- ✅ 在每个python命令前添加 `conda run -n talking_gaussian --no-capture-output`
- ✅ 保持现有逻辑不变

**修改示例**：
```bash
# 修改前
python train_mouth.py -s $dataset -m $workspace ...

# 修改后
conda run -n talking_gaussian --no-capture-output python train_mouth.py -s $dataset -m $workspace ...
```

#### 3. 新建 CosyVoice/run_cosyvoice.sh ✅
- ✅ 封装CosyVoice调用
- ✅ 使用 `conda run -n cosyvoice --no-capture-output`
- ✅ 支持所有原有参数（model_dir, prompt_wav, prompt_text, tts_text, language, speed, output_file）

**脚本内容**：
```bash
#!/usr/bin/env bash
# 解析参数...
conda run -n cosyvoice --no-capture-output \
    python test_cosyvoice.py "${CMD_ARGS[@]}"
```

#### 4. backend/chat_engine.py ✅
- ✅ 改为调用 `bash CosyVoice/run_cosyvoice.sh`
- ✅ 不再直接调用python
- ✅ Python代码保持简洁

**修改示例**：
```python
# 修改前
cmd = ['python', './CosyVoice/test_cosyvoice.py', ...]

# 修改后
cmd = ['bash', './CosyVoice/run_cosyvoice.sh', ...]
```

#### 5. backend/model_trainer.py ✅
- ✅ 数据预处理部分：添加 `conda run -n talking_gaussian --no-capture-output`

**修改示例**：
```python
# 修改前
preprocess_cmd = ['python', 'TalkingGaussian/data_utils/process.py', ...]

# 修改后
preprocess_cmd = [
    'conda', 'run', '-n', 'talking_gaussian', '--no-capture-output',
    'python', 'TalkingGaussian/data_utils/process.py', ...
]
```

---

## 六、运行方式说明

### 6.1 当前运行方式（不推荐）

```bash
# 在base环境运行Flask
conda activate base
python app.py
```

**问题**：
- TalkingGaussian脚本会失败（缺少依赖）
- CosyVoice脚本会失败（缺少依赖）

### 6.2 正确的运行方式（需要修改代码后）

```bash
# 在base环境运行Flask（推荐）
conda activate base
python app.py

# 或者创建专门的Flask环境
conda create -n flask_env python=3.10
conda activate flask_env
pip install flask speech-recognition zhipuai
python app.py
```

**关键**：Flask应用本身不需要TalkingGaussian或CosyVoice的依赖，只需要：
- Flask
- speech-recognition（ASR）
- zhipuai（LLM API）

---

## 七、Docker构建方案

### 7.1 当前状态：还不能构建Docker

**原因**：
1. ❌ 环境切换机制未实现
2. ❌ 需要确认所有依赖
3. ❌ 需要统一环境管理

### 7.2 Docker构建策略

#### 方案一：多阶段构建（推荐）

```dockerfile
# 阶段1：TalkingGaussian环境
FROM nvidia/cuda:11.3-cudnn8-runtime-ubuntu20.04 as talkinggaussian
# 安装conda, 创建talking_gaussian环境
COPY TalkingGaussian/ /app/TalkingGaussian/
RUN conda env create -f TalkingGaussian/environment.yml

# 阶段2：CosyVoice环境
FROM nvidia/cuda:12.1-cudnn8-runtime-ubuntu22.04 as cosyvoice
# 安装conda, 创建cosyvoice环境
COPY CosyVoice/ /app/CosyVoice/
RUN conda env create -n cosyvoice python=3.10
RUN conda run -n cosyvoice pip install -r CosyVoice/requirements.txt

# 阶段3：最终镜像（包含所有环境）
FROM nvidia/cuda:12.1-cudnn8-runtime-ubuntu22.04
# 安装conda
# 从阶段1复制talking_gaussian环境
# 从阶段2复制cosyvoice环境
# 安装Flask应用依赖
COPY . /app/
WORKDIR /app
CMD ["python", "app.py"]
```

#### 方案二：使用conda-pack（轻量级）

```dockerfile
FROM nvidia/cuda:12.1-cudnn8-runtime-ubuntu22.04
# 安装conda
# 使用conda-pack打包环境
COPY talking_gaussian.tar.gz /opt/conda/envs/
COPY cosyvoice.tar.gz /opt/conda/envs/
# 解压环境
```

#### 方案三：单一环境（不推荐）

尝试在一个环境中安装所有依赖，但PyTorch版本冲突问题难以解决。

### 7.3 Docker构建前提条件

**需要完成**：
1. ✅ 实现环境切换机制（使用conda run）
2. ✅ 确认所有依赖清单
3. ✅ 测试完整流程
4. ✅ 统一路径管理（已完成）

**Dockerfile结构**：
```
/app/
├── TalkingGaussian/     # TalkingGaussian项目
├── CosyVoice/           # CosyVoice项目
├── backend/            # Flask后端
├── templates/          # 前端模板
├── static/             # 静态文件
└── app.py              # Flask主应用
```

---

## 八、流程对比

### 8.1 原先流程 vs 现在流程

| 步骤 | 原先流程 | 现在流程 | 一致性 |
|------|---------|---------|--------|
| **TalkingGaussian训练** | 手动激活环境 → 运行脚本 | Flask → backend → conda run → 脚本 | ⚠️ 需要添加conda run |
| **CosyVoice推理** | 手动激活环境 → 运行脚本 | Flask → backend → conda run → 脚本 | ⚠️ 需要添加conda run |
| **实时对话** | 手动执行多个步骤 | Flask → backend → 自动串联 | ✅ 流程一致，但需要环境切换 |

### 8.2 关键差异

**原先**：
- 用户手动切换环境
- 用户手动执行每个步骤
- 环境隔离清晰

**现在**：
- Flask自动调用脚本
- 需要自动环境切换（**当前缺失**）
- 流程自动化，但环境管理更复杂

---

## 九、立即需要修改的内容

### 9.1 必须修改（否则无法运行）

**推荐方案：在Shell脚本中使用conda run**

1. **TalkingGaussian/run_talkinggaussian.sh**
   - 在python命令前添加 `conda run -n talking_gaussian --no-capture-output`

2. **TalkingGaussian/scripts/train_xx.sh**
   - 在每个python命令前添加 `conda run -n talking_gaussian --no-capture-output`

3. **新建 CosyVoice/run_cosyvoice.sh**
   - 封装CosyVoice调用，使用 `conda run -n cosyvoice --no-capture-output`

4. **backend/chat_engine.py**
   - 改为调用 `bash CosyVoice/run_cosyvoice.sh`（不再直接调用python）

5. **backend/model_trainer.py**
   - 数据预处理：可以创建Shell脚本或直接添加conda run

### 9.2 可选修改（提升稳定性）

1. 添加环境检查函数（检查conda环境是否存在）
2. 添加错误处理（环境不存在时的提示）
3. 添加conda路径自动检测（使用 `conda info --base`）

---

## 十、运行步骤（修改代码后）

### 10.1 启动Flask应用

```bash
# 方式1：在base环境运行（推荐）
conda activate base
pip install flask speech-recognition zhipuai  # 如果未安装
python app.py

# 方式2：创建专门的Flask环境
conda create -n flask_env python=3.10
conda activate flask_env
pip install flask speech-recognition zhipuai
python app.py
```

### 10.2 访问应用

- 首页：http://localhost:5001/
- 视频生成：http://localhost:5001/video_generation
- 模型训练：http://localhost:5001/model_training
- 实时对话：http://localhost:5001/chat_system

### 10.3 环境自动切换

当用户操作时：
- 视频生成/训练 → 自动使用 `talking_gaussian` 环境
- 语音克隆 → 自动使用 `cosyvoice` 环境
- ASR/LLM → 使用当前Flask环境

---

## 十一、Docker构建时机

### 11.1 当前状态：❌ 还不能构建

**原因**：
1. 环境切换机制未实现
2. 需要先测试完整流程
3. 需要确认所有依赖

### 11.2 可以构建Docker的条件

✅ **完成以下工作后可以构建**：
1. 实现conda run环境切换
2. 测试三个页面完整流程
3. 确认所有依赖清单
4. 统一路径管理（已完成）
5. 前端修改完成（可选）

### 11.3 Docker构建步骤（未来）

```bash
# 1. 准备环境
conda-pack -n talking_gaussian -o talking_gaussian.tar.gz
conda-pack -n cosyvoice -o cosyvoice.tar.gz

# 2. 构建Docker镜像
docker build -t tfg_ui:latest .

# 3. 运行容器
docker run -d \
  --gpus all \
  -p 5001:5001 \
  -v /path/to/models:/app/models \
  tfg_ui:latest
```

---

## 十二、总结

### 12.1 当前状态

✅ **已完成**：
- 路径统一（相对路径）
- 参数传递（sh_degree, speed）
- 流程整合（三个页面）
- **环境切换机制** 
  - TalkingGaussian/run_talkinggaussian.sh 已添加 conda run
  - TalkingGaussian/scripts/train_xx.sh 已添加 conda run
  - CosyVoice/run_cosyvoice.sh 已创建并封装环境切换
  - backend/chat_engine.py 已改为调用Shell脚本
  - backend/model_trainer.py 数据预处理已添加 conda run

⚠️ **待测试**：
- 完整流程测试（三个页面）
- Docker构建准备

### 12.2 下一步行动

1. ✅ **已完成**：添加conda run环境切换
2. **测试验证**：测试完整流程（三个页面）
3. **Docker准备**：确认依赖清单
4. **构建Docker**：完成测试后

### 12.3 环境切换示例

**方案：在Shell脚本中使用conda run**

**修改前（Shell脚本）**：
```bash
python test_talkinggaussian.py "$@"
```

**修改后（Shell脚本）**：
```bash
conda run -n talking_gaussian --no-capture-output \
    python test_talkinggaussian.py "$@"
```

**Python代码保持不变**：
```python
# Python代码保持简洁，只调用Shell脚本
cmd = ['bash', 'TalkingGaussian/run_talkinggaussian.sh', 'infer', ...]
subprocess.run(cmd)
```

---
