# 参数配置与前端交互设计说明

## 一、当前自定义参数实现情况

### 1.1 现状
- **前端**：`model_training.html` 中有一个文本输入框 `<textarea name="custom_params">`
- **后端**：`app.py` 中接收了 `custom_params` 参数，但 `model_trainer.py` 中**未实际使用**
- **问题**：目前只是一个占位符，没有实际功能

### 1.2 自定义参数的要求
如果要实现真正的自定义参数，需要：
1. **格式要求**：JSON 格式或键值对格式（如 `--param1 value1 --param2 value2`）
2. **参数验证**：需要验证参数名是否合法
3. **参数传递**：需要将参数传递给训练脚本

**建议**：不推荐使用纯文本输入框，因为：
- 用户容易输入错误格式
- 难以验证参数合法性
- 用户体验差

**更好的方案**：使用结构化的参数配置界面（见下文）

---

## 二、TalkingGaussian 可调整参数

### 2.1 训练阶段参数（Model Training）

#### 核心训练参数

| 参数名 | 类型 | 默认值 | 范围 | 说明 |
|--------|------|--------|------|------|
| `iterations` | int | 50,000 | 5,000-100,000 | 训练迭代次数，影响模型质量和训练时间 |
| `sh_degree` | int | 2 | 0-3 | Spherical Harmonics 度数，控制渲染细节 |
| `position_lr_init` | float | 0.00016 | 0.00001-0.001 | 位置学习率初始值 |
| `feature_lr` | float | 0.0025 | 0.0001-0.01 | 特征学习率 |
| `opacity_lr` | float | 0.05 | 0.001-0.1 | 不透明度学习率 |
| `densify_grad_threshold` | float | 0.0002 | 0.0001-0.001 | 密度化梯度阈值，控制点云增长 |
| `audio_extractor` | str | "deepspeech" | ["deepspeech", "hubert"] | 音频特征提取器 |

#### 高级训练参数（不建议前端暴露）

- `position_lr_final`: 位置学习率最终值
- `position_lr_delay_mult`: 学习率延迟倍数
- `scaling_lr`: 缩放学习率
- `rotation_lr`: 旋转学习率
- `percent_dense`: 密度百分比
- `lambda_dssim`: DSSIM 损失权重
- `densification_interval`: 密度化间隔
- `densify_from_iter`: 开始密度化的迭代数
- `densify_until_iter`: 停止密度化的迭代数

### 2.2 推理阶段参数（Video Generation / Chat System）

| 参数名 | 类型 | 默认值 | 范围 | 说明 |
|--------|------|--------|------|------|
| `sh_degree` | int | 2 | 0-3 | 渲染细节等级，影响画质和速度 |
| `audio_extractor` | str | "deepspeech" | ["deepspeech", "hubert"] | 音频特征提取器 |
| `fast` | bool | False | True/False | 快速模式，降低渲染质量以提升速度 |
| `dilate` | bool | False | True/False | 膨胀模式，用于某些特殊效果 |

---

## 三、CosyVoice 可调整参数

### 3.1 语音合成参数

| 参数名 | 类型 | 默认值 | 范围 | 说明 |
|--------|------|--------|------|------|
| `speed` | float | 1.0 | 0.5-2.0 | 语速调节，1.0为正常速度 |
| `text_frontend` | bool | True | True/False | 文本规范化开关，优化数字、标点读法 |
| `stream` | bool | False | True/False | 流式推理，实时生成音频 |
| `language` | str | "zh" | ["zh", "en"] | 输出语言类型 |

### 3.2 当前实现情况

查看 `test_cosyvoice.py` 和 `chat_engine.py`：
- ✅ `language` 已支持
- ❌ `speed` **未实现**（需要修改 `test_cosyvoice.py`）
- ❌ `text_frontend` **未实现**（需要修改 `test_cosyvoice.py`）
- ❌ `stream` **未实现**（流式推理需要特殊处理）

---

## 四、参数调整的意义

### 4.1 TalkingGaussian 参数意义

#### `iterations` (训练迭代次数)
- **低值 (5,000-10,000)**：快速预览，适合快速测试
- **中值 (20,000-30,000)**：标准质量，平衡效果和时间
- **高值 (50,000+)**：高质量，细节更清晰，但训练时间长

#### `sh_degree` (渲染细节等级)
- **0**：极速模式，仅基础颜色，无光照效果
- **1**：标准模式，基础光照，平衡画质和速度
- **2-3**：高保真模式，完整光照和材质反光，画质最佳但速度较慢

#### `densify_grad_threshold` (密度化阈值)
- **低值**：更严格，点云增长少，画面更稳定
- **高值**：更宽松，点云增长多，细节更丰富但可能出现伪影

### 4.2 CosyVoice 参数意义

#### `speed` (语速)
- **< 1.0**：慢速，沉稳、清晰
- **1.0**：正常速度
- **> 1.0**：快速，活泼、紧凑

#### `text_frontend` (文本规范化)
- **True**：自动优化数字、标点读法，更自然
- **False**：原始文本，响应更快但可能不自然

---

## 五、前端可展示的交互设计

### 5.1 方案评估（基于用户提供的方案）

#### ✅ **方案一：语音表现调节（推荐）**
**适用页面**：实时对话页 (Chat System) / 视频生成页 (Video Generation)

**优点**：
- 效果立竿见影，用户容易理解
- 实现简单，只需修改 `test_cosyvoice.py`
- 用户体验好

**实现**：
1. **语速调节 (Speed)**
   - UI：滑块 (Slider)
   - 范围：0.5 ~ 2.0
   - 默认值：1.0
   - 文案："调节数字人的说话节奏。数值越小语速越慢（沉稳），数值越大语速越快（活泼）。"

2. **文本规范化 (Text Normalization)**
   - UI：开关 (Toggle Switch)
   - 标签："启用文本规范化"
   - 文案："开启后自动优化文本中的数字、标点读法，使朗读更自然；关闭可提高响应速度。"

#### ✅ **方案二：视觉渲染质量调节（推荐）**
**适用页面**：视频生成页 (Video Generation) / 实时对话页 (Chat System)

**优点**：
- 直观体现画质与速度的权衡
- 符合 Gaussian Splatting 的特性
- 用户容易理解

**实现**：
1. **渲染细节等级 (Detail Level / SH Degree)**
   - UI：单选按钮组 (Radio Group) 或下拉菜单
   - 选项：
     - **极速模式 (SH=0)**：仅渲染基础颜色，无光泽感，速度最快
     - **标准模式 (SH=1)**：包含基础光照信息，平衡画质与速度
     - **高保真模式 (SH=2/3)**：完整渲染环境光与材质反光，画质最真实，但生成稍慢

#### ⚠️ **方案三：训练策略干预（部分推荐）**
**适用页面**：模型训练页 (Model Training)

**优点**：
- 体现专业性，让用户"定义"数字人的行为习惯
- 差异化功能

**缺点**：
- 实现复杂，需要修改训练脚本
- 用户可能不理解参数含义
- 训练时间长，难以快速验证效果

**推荐实现**：
1. **训练时长/质量权衡 (Training Quality)**
   - UI：分段选择器 (Segmented Control)
   - 选项：
     - **快速预览 (5,000 步)**：适合快速看效果，大概几分钟
     - **标准训练 (20,000 步)**：适合大多数情况
     - **深度精修 (50,000 步)**：默认值，效果最好，耗时最长
   - 文案："增加训练步数可以提升牙齿、口腔内部的细节清晰度，但会显著增加等待时间。"

**不推荐实现**：
- **眨眼/表情灵敏度 (Expression Sensitivity)**：参数 `au_window` 在代码中未找到，可能不存在或已废弃

---

## 六、后端接口设计

### 6.1 训练参数接口

#### 接口：`POST /model_training`

**请求参数**（新增）：
```json
{
  "model_choice": "TalkingGaussian",
  "ref_video": "TalkingGaussian/data/May/May.mp4",
  "gpu_choice": "GPU0",
  "epoch": "1000",
  
  // 新增：结构化训练参数
  "training_params": {
    "iterations": 50000,           // 训练迭代次数
    "sh_degree": 2,                // 渲染细节等级
    "audio_extractor": "deepspeech" // 音频特征提取器
  }
}
```

**后端处理**：
- 在 `model_trainer.py` 中解析 `training_params`
- 将参数传递给训练脚本（修改 `train_xx.sh` 或直接调用 Python 脚本）

### 6.2 推理参数接口

#### 接口：`POST /video_generation`

**请求参数**（新增）：
```json
{
  "model_name": "TalkingGaussian",
  "model_param": "output/talking_May",
  "ref_audio": "static/audios/test.wav",
  "gpu_choice": "GPU0",
  
  // 新增：推理参数
  "inference_params": {
    "sh_degree": 2,                // 渲染细节等级
    "audio_extractor": "deepspeech", // 音频特征提取器
    "fast": false                   // 快速模式
  }
}
```

#### 接口：`POST /chat_system`

**请求参数**（新增）：
```json
{
  "model_name": "TalkingGaussian",
  "model_param": "output/talking_May",
  "voice_clone_type": "preset_voice",
  "preset_voice_name": "default",
  
  // 新增：CosyVoice 参数
  "cosyvoice_params": {
    "speed": 1.0,                  // 语速
    "text_frontend": true           // 文本规范化
  },
  
  // 新增：TalkingGaussian 推理参数
  "inference_params": {
    "sh_degree": 2,
    "audio_extractor": "deepspeech"
  }
}
```

### 6.3 参数配置查询接口（可选）

#### 接口：`GET /api/training_params`

**功能**：返回可配置的参数列表和默认值

**响应**：
```json
{
  "status": "success",
  "model": "TalkingGaussian",
  "params": {
    "iterations": {
      "type": "int",
      "default": 50000,
      "min": 5000,
      "max": 100000,
      "description": "训练迭代次数"
    },
    "sh_degree": {
      "type": "int",
      "default": 2,
      "min": 0,
      "max": 3,
      "description": "渲染细节等级"
    }
  }
}
```

---

## 七、实现优先级建议

### 高优先级（必须实现）
1. ✅ **CosyVoice 语速调节**：实现简单，效果明显
2. ✅ **CosyVoice 文本规范化开关**：实现简单，提升用户体验
3. ✅ **TalkingGaussian 渲染细节等级**：直观体现画质与速度权衡

### 中优先级（建议实现）
4. ⚠️ **训练时长选择**：需要修改训练脚本，但用户体验好
5. ⚠️ **TalkingGaussian 快速模式**：已有参数，只需前端暴露

### 低优先级（可选实现）
6. ❌ **高级训练参数**：用户难以理解，不建议前端暴露
7. ❌ **流式推理**：需要特殊处理，实现复杂

---

## 八、技术实现要点

### 8.1 CosyVoice 参数实现

**需要修改**：`TalkingGaussian/test_cosyvoice.py`

```python
# 添加参数
parser.add_argument('--speed', type=float, default=1.0, help='语速调节')
parser.add_argument('--text_frontend', type=bool, default=True, help='文本规范化')

# 修改调用
cosyvoice.inference_zero_shot(
    tts_text,
    prompt_text,
    prompt_speech_16k,
    stream=False,
    speed=args.speed,              # 新增
    text_frontend=args.text_frontend  # 新增
)
```

### 8.2 TalkingGaussian 参数实现

**需要修改**：
1. `run_talkinggaussian.sh`：添加 `--sh_degree` 参数
2. `test_talkinggaussian.py`：解析并传递参数
3. `synthesize_fuse.py`：使用 `sh_degree` 参数

---

## 九、总结

### 推荐实现的功能

1. **实时对话页**：
   - ✅ 语速调节（滑块）
   - ✅ 文本规范化开关
   - ✅ 渲染细节等级选择

2. **视频生成页**：
   - ✅ 渲染细节等级选择
   - ✅ 快速模式开关（可选）

3. **模型训练页**：
   - ✅ 训练时长选择（快速预览/标准/深度精修）
   - ❌ 不推荐暴露高级训练参数

### 不推荐的功能

- ❌ 纯文本自定义参数输入框（用户体验差）
- ❌ 高级训练参数（用户难以理解）
- ❌ 眨眼/表情灵敏度（参数可能不存在）

