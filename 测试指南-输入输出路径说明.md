# 测试指南：输入输出路径说明

## 一、页面输入路径说明

### 1.1 模型训练页面（`/model_training`）

**输入参数**：
- **参考视频地址**（必填）
  - 推荐：`static/uploads/videos/May.mp4`（用户上传入口，系统会自动复制到 `TalkingGaussian/data/May/May.mp4` 并预处理）
  - 兼容：`TalkingGaussian/data/May/May.mp4`
  - 格式：相对路径，相对于项目根目录
  - 说明：训练用的原始视频文件
  
- **模型选择**：TalkingGaussian 或 SyncTalk

- **GPU选择**：GPU0 或 GPU1

- **Epoch（训练轮数）**：仅SyncTalk模型需要

**输出位置**：
- **模型保存路径**：`TalkingGaussian/output/<project_name>/`
  - `<project_name>` 通常是从视频文件名提取的ID（如 `May`）
  - 返回给前端的路径格式：`output/<project_name>`（相对路径）
  - **文件覆盖情况**：如果同名项目已存在，会覆盖原有模型文件

**模型文件结构**：
```
TalkingGaussian/output/<project_name>/
├── chkpnt_face_latest.pth      # 面部训练检查点
├── chkpnt_mouth_latest.pth     # 嘴部训练检查点
├── chkpnt_fuse_latest.pth      # 融合训练检查点
└── ...（其他训练相关文件）
```

---

### 1.2 视频生成页面（`/video_generation`）

**输入参数**：
- **模型目录地址**（必填）
  - 示例：`output/May` 或 `output/talking_May`
  - 格式：相对路径，相对于 `TalkingGaussian/` 目录
  - 说明：使用训练好的模型路径

- **参考音频地址**（必填）
  - 推荐：`static/uploads/audios/may_reference.wav`
    - 说明：训练完成后，系统会自动将 `TalkingGaussian/data/May/aud.wav` 复制为 `static/uploads/audios/may_reference.wav`，可直接作为 TalkingGaussian 推理的参考音频
  - 兼容：`static/audios/test.wav`
  - 格式：相对路径，相对于项目根目录
  - 说明：用于生成说话视频的音频文件

- **模型名称**：TalkingGaussian 或 SyncTalk

- **GPU选择**：GPU0 或 GPU1

- **渲染质量等级**（sh_degree）：0-3，默认2

**输出位置**：
- **视频保存路径**：`static/videos/`
  - **文件命名规则**：`talkinggaussian_<audio_name>.mp4`
  - 示例：如果音频是 `test.wav`，则输出为 `talkinggaussian_test.mp4`
  - **时间戳功能**：**有**，TalkingGaussian脚本会自动添加时间戳
  - **实际文件名格式**：`talkinggaussian_<audio_name>_<YYYYMMDD_HHMMSS>.mp4`
  - 例如：`talkinggaussian_test_20250128_143025.mp4`

**文件覆盖情况**：
- **不会覆盖**：每次生成都会创建带时间戳的新文件
- **查找逻辑**：后端会查找最新的带时间戳文件（1分钟内生成的文件）

---

### 1.3 实时对话页面（`/chat_system`）

**输入参数**：

1. **语音录制**（通过录音按钮）
   - 保存路径：`static/audios/input.wav`
   - **文件覆盖情况**：**会覆盖**，每次录音都会覆盖 `input.wav`

2. **模型目录地址**（必填）
   - 示例：`output/talking_May`
   - 格式：相对路径

3. **语音克隆参考音频选择**：
   - **当前录音**：使用 `static/audios/input.wav`（会被覆盖）
   - **预设音色**：
     - CosyVoice 自带音色：`CosyVoice/asset/zero_shot_prompt.wav`、`CosyVoice/asset/cross_lingual_prompt.wav`
     - **训练视频提取音色（推荐）**：`static/uploads/audios/may_reference.wav`（在 `backend/chat_engine.py` 中注册为预设音色 `may`）
   - **自定义上传**：上传到 `static/audios/custom_voice/`，文件名格式：`custom_voice_<timestamp>.<ext>`
     - **时间戳功能**：**有**，避免覆盖
     - 示例：`custom_voice_1706425025.wav`

4. **其他参数**：
   - 语言类型：zh（中文）或 en（英文）
   - 语速：0.5-2.0
   - 渲染质量等级：0-3
   - API选择：openai、zhipu、deepseek

**中间文件输出位置**：

1. **用户录音**：
   - 主文件：`static/audios/input.wav`（会被覆盖）
   - 时间戳副本：`static/audios/input_<YYYYMMDD_HHMMSS>.wav`（保留历史）
   - **文件覆盖情况**：主文件会覆盖，但会同时保存带时间戳的副本

2. **ASR识别结果**：
   - 主文件：`static/text/input.txt`（会被覆盖）
   - 时间戳副本：`static/text/input_<YYYYMMDD_HHMMSS>.txt`（保留历史）
   - **文件覆盖情况**：主文件会覆盖，但会同时保存带时间戳的副本

3. **LLM回复文本**：
   - 主文件：`static/text/output.txt`（会被覆盖）
   - 时间戳副本：`static/text/output_<YYYYMMDD_HHMMSS>.txt`（保留历史）
   - **文件覆盖情况**：主文件会覆盖，但会同时保存带时间戳的副本

4. **语音合成输出**：
   - 主文件：`static/audios/tts_output.wav`（会被覆盖）
   - 时间戳副本：`static/audios/tts_output_<YYYYMMDD_HHMMSS>.wav`（保留历史）
   - **文件覆盖情况**：主文件会覆盖，但会同时保存带时间戳的副本
   - 说明：CosyVoice生成的语音克隆音频

5. **最终视频输出**：
   - 路径：`static/videos/`
   - 文件命名：`talkinggaussian_tts_output_<YYYYMMDD_HHMMSS>.mp4`
   - **时间戳功能**：**有**，TalkingGaussian脚本自动添加时间戳
   - **文件覆盖情况**：**不覆盖**，每次生成都会创建新文件

---

## 二、文件路径汇总表

| 功能模块 | 输入路径 | 输出路径 | 时间戳 | 覆盖情况 |
|---------|---------|---------|--------|----------|
| **模型训练** | 推荐：`static/uploads/videos/<ID>.mp4`<br>内部：`TalkingGaussian/data/<ID>/<ID>.mp4` | `TalkingGaussian/output/<project_name>/` | ❌ 无 | ✅ 覆盖同名模型 |
| **视频生成** | 推荐：`static/uploads/audios/<ID>_reference.wav`<br>兼容：`static/audios/*.wav`<br>模型：`output/<model_name>` | `static/videos/talkinggaussian_<name>_<timestamp>.mp4` | ✅ 有 | ❌ 不覆盖 |
| **实时对话-录音** | 用户录音 | `static/audios/input.wav`<br>`static/audios/input_<timestamp>.wav` | ✅ 有（副本） | ✅ 覆盖主文件，保留副本 |
| **实时对话-ASR** | `static/audios/input.wav` | `static/text/input.txt`<br>`static/text/input_<timestamp>.txt` | ✅ 有（副本） | ✅ 覆盖主文件，保留副本 |
| **实时对话-LLM** | `static/text/input.txt` | `static/text/output.txt`<br>`static/text/output_<timestamp>.txt` | ✅ 有（副本） | ✅ 覆盖主文件，保留副本 |
| **实时对话-TTS** | `static/text/output.txt`<br>`参考音频` | `static/audios/tts_output.wav`<br>`static/audios/tts_output_<timestamp>.wav` | ✅ 有（副本） | ✅ 覆盖主文件，保留副本 |
| **实时对话-视频** | `static/audios/tts_output.wav` | `static/videos/talkinggaussian_tts_output_<timestamp>.mp4` | ✅ 有 | ❌ 不覆盖 |
| **自定义语音上传** | 用户上传 | `static/audios/custom_voice/custom_voice_<timestamp>.<ext>` | ✅ 有 | ❌ 不覆盖 |

---

## 三、时间戳详细说明

### 3.1 带时间戳的文件

1. **视频生成输出**（TalkingGaussian）
   - **格式**：`<base_name>_<YYYYMMDD_HHMMSS>.mp4`
   - **示例**：`talkinggaussian_test_20250128_143025.mp4`
   - **生成位置**：`static/videos/`
   - **原因**：`run_talkinggaussian.sh` 脚本自动添加时间戳，避免文件覆盖

2. **自定义语音克隆音频**
   - **格式**：`custom_voice_<unix_timestamp>.<ext>`
   - **示例**：`custom_voice_1706425025.wav`
   - **生成位置**：`static/audios/custom_voice/`
   - **原因**：`app.py` 中的 `/upload_voice_clone` 路由使用时间戳避免覆盖

### 3.2 带时间戳副本的文件（主文件会被覆盖，但保留历史副本）

1. **用户录音**：
   - 主文件：`static/audios/input.wav`（会被覆盖）
   - 时间戳副本：`static/audios/input_<YYYYMMDD_HHMMSS>.wav`（保留历史）

2. **ASR识别结果**：
   - 主文件：`static/text/input.txt`（会被覆盖）
   - 时间戳副本：`static/text/input_<YYYYMMDD_HHMMSS>.txt`（保留历史）

3. **LLM回复文本**：
   - 主文件：`static/text/output.txt`（会被覆盖）
   - 时间戳副本：`static/text/output_<YYYYMMDD_HHMMSS>.txt`（保留历史）

4. **语音合成输出**：
   - 主文件：`static/audios/tts_output.wav`（会被覆盖）
   - 时间戳副本：`static/audios/tts_output_<YYYYMMDD_HHMMSS>.wav`（保留历史）

**说明**：这些文件需要固定名称供后续流程使用，但同时会保存带时间戳的副本用于历史记录。

### 3.3 会被覆盖的文件（无时间戳）

1. **模型训练输出**：`TalkingGaussian/output/<project_name>/`
   - 如果使用相同的project_name，会覆盖原有模型

---

## 四、测试建议

### 4.1 模型训练测试

1. **输入准备**：
   ```bash
   # 确保训练视频存在
   ls TalkingGaussian/data/May/May.mp4
   ```

2. **测试步骤**：
   - 输入参考视频路径：`TalkingGaussian/data/May/May.mp4`
   - 选择GPU：GPU0
   - 点击训练

3. **验证输出**：
   ```bash
   # 检查模型是否生成
   ls TalkingGaussian/output/May/
   # 应该看到 chkpnt_face_latest.pth, chkpnt_mouth_latest.pth, chkpnt_fuse_latest.pth
   ```

4. **注意事项**：
   - 同名项目会覆盖，测试时注意使用不同的project_name
   - 训练时间较长，请耐心等待

---

### 4.2 视频生成测试

1. **输入准备**：
   ```bash
   # 准备测试音频
   # 确保模型已训练
   ls TalkingGaussian/output/May/chkpnt_fuse_latest.pth
   ```

2. **测试步骤**：
   - 输入模型路径：`output/May`
   - 输入音频路径：`static/audios/test.wav`
   - 选择GPU和渲染质量
   - 点击生成

3. **验证输出**：
   ```bash
   # 检查生成的文件（带时间戳）
   ls -lt static/videos/talkinggaussian_test_*.mp4 | head -1
   ```

4. **注意事项**：
   - 每次生成都会创建新文件，不会覆盖
   - 可以多次生成测试不同参数的效果

---

### 4.3 实时对话测试

1. **输入准备**：
   ```bash
   # 确保模型已训练
   ls TalkingGaussian/output/May/chkpnt_fuse_latest.pth
   # 确保API配置正确
   cat backend/config/api_config.json
   ```

2. **测试步骤**：
   - 点击"开始录音"，录制语音
   - 选择模型路径：`output/May`
   - 选择语音克隆方式
   - 配置其他参数（语言、语速、渲染质量等）
   - 点击"开始对话"

3. **验证中间文件**：
   ```bash
   # ASR结果（主文件和最新副本）
   cat static/text/input.txt
   ls -lt static/text/input_*.txt | head -1
   
   # LLM回复（主文件和最新副本）
   cat static/text/output.txt
   ls -lt static/text/output_*.txt | head -1
   
   # 语音合成输出（主文件和最新副本）
   ls -lh static/audios/tts_output.wav
   ls -lt static/audios/tts_output_*.wav | head -1
   
   # 用户录音（主文件和最新副本）
   ls -lt static/audios/input_*.wav | head -1
   
   # 最终视频（带时间戳）
   ls -lt static/videos/talkinggaussian_tts_output_*.mp4 | head -1
   ```

4. **注意事项**：
   - 所有中间文件的主文件会被覆盖，但会自动保存带时间戳的副本
   - 时间戳格式：`YYYYMMDD_HHMMSS`（如 `20250128_143025`）
   - 可以通过时间戳副本查看历史记录
   - 建议定期清理旧的时间戳副本文件以节省空间

---

## 五、文件查找和清理建议

### 5.1 查找最新生成的文件

```bash
# 查找最新的视频文件
find static/videos -name "*.mp4" -type f -printf '%T@ %p\n' | sort -n | tail -1

# 查找自定义语音文件
ls -lt static/audios/custom_voice/ | head -10

# 查找带时间戳的文件
ls static/videos/*_2025*.mp4
```

### 5.2 清理旧文件

```bash
# 清理旧的视频文件（保留最近10个）
cd static/videos
ls -t *.mp4 | tail -n +11 | xargs rm -f

# 清理自定义语音文件（保留最近20个）
cd static/audios/custom_voice
ls -t custom_voice_* | tail -n +21 | xargs rm -f
```

### 5.3 检查当前状态

```bash
# 检查所有输入输出目录
echo "=== 音频目录 ==="
ls -lh static/audios/
echo ""
echo "=== 视频目录 ==="
ls -lh static/videos/ | head -10
echo ""
echo "=== 文本目录 ==="
ls -lh static/text/
echo ""
echo "=== 模型目录 ==="
ls -d TalkingGaussian/output/*/
```

---

## 六、常见问题

### Q1: 为什么有些文件会被覆盖？

**A**: 系统设计时，中间文件（如录音、ASR结果、LLM回复等）需要固定名称供后续流程使用，所以主文件会被覆盖。但现在系统会自动保存带时间戳的副本，可以用于查看历史记录。

### Q2: 如何保留多次对话的结果？

**A**: 
- 对于视频文件，已经有时间戳功能，会自动保留
- 对于中间文件（input.txt, output.txt, tts_output.wav, input.wav），系统现在会自动保存带时间戳的副本
- 所有带时间戳的文件都保存在同一目录下，可以通过时间戳查看历史记录

### Q3: 时间戳格式是什么？

**A**: 
- TalkingGaussian视频：`YYYYMMDD_HHMMSS`（如 `20250128_143025`）
- 自定义语音上传：Unix时间戳（如 `1706425025`）

### Q4: 如何确认文件是否成功生成？

**A**: 
- 检查文件是否存在：`ls <文件路径>`
- 检查文件大小：`ls -lh <文件路径>`（不应为0字节）
- 检查文件修改时间：`stat <文件路径>`（应该是最近生成的）
- 查看最新的时间戳副本：`ls -lt static/<dir>/*_*.txt` 或 `ls -lt static/<dir>/*_*.wav`

### Q5: 时间戳副本会占用很多空间吗？

**A**: 
- 文本文件（.txt）很小，通常只有几KB
- 音频文件（.wav）较大，但可以通过定期清理旧文件来管理
- 建议定期清理超过一定天数的旧文件（如30天）

---

## 七、测试检查清单

- [ ] 模型训练：检查模型文件是否在 `TalkingGaussian/output/<project_name>/` 生成
- [ ] 视频生成：检查视频文件是否在 `static/videos/` 生成，且带有时间戳
- [ ] 录音功能：检查 `static/audios/input.wav` 是否正确保存，以及是否有时间戳副本
- [ ] ASR识别：检查 `static/text/input.txt` 是否包含识别结果，以及是否有时间戳副本
- [ ] LLM回复：检查 `static/text/output.txt` 是否包含AI回复，以及是否有时间戳副本
- [ ] 语音合成：检查 `static/audios/tts_output.wav` 是否生成，以及是否有时间戳副本
- [ ] 最终视频：检查 `static/videos/` 中是否生成带时间戳的对话视频
- [ ] 自定义语音上传：检查 `static/audios/custom_voice/` 中的文件是否带时间戳
- [ ] 时间戳功能：确认所有中间文件都有时间戳副本
- [ ] 文件保留：确认可以通过时间戳查看历史记录



